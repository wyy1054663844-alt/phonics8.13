<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>IPA Trainer â€” /É™/ /Éš/ /ÉË/ï¼ˆTTS + å½•éŸ³å­˜å‚¨ï¼‰</title>
<style>
  :root{--bg:#0b1022;--bg2:#0f172a;--border:#1f2937;--txt:#e5e7eb;--muted:#9ca3af;
        --primary:#60a5fa;--cyan:#22d3ee;--green:#22c55e;--red:#ef4444}
  *{box-sizing:border-box} body{margin:0;background:linear-gradient(180deg,var(--bg),var(--bg2) 30%,var(--bg));
  color:var(--txt);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif}
  .wrap{max-width:1100px;margin:24px auto;padding:16px}
  h1{margin:0 0 8px;font-weight:800} .sub{color:var(--muted);margin:0 0 16px}
  .toolbar{display:flex;flex-wrap:wrap;gap:8px;margin:10px 0 18px}
  .pill{display:inline-flex;align-items:center;gap:8px;background:#0b1228;border:1px solid var(--border);
        padding:8px 10px;border-radius:12px}
  button{border:0;border-radius:10px;padding:8px 12px;font-weight:700;cursor:pointer;color:#041422;background:#2d3648}
  button.primary{background:var(--primary)} button.secondary{background:var(--cyan)}
  button.success{background:var(--green);color:#052e16} button.warn{background:var(--red);color:#3a0a0a}
  .grid{display:grid;grid-template-columns:repeat(3,minmax(280px,1fr));gap:14px}
  @media (max-width:1100px){.grid{grid-template-columns:1fr}}
  .card{background:rgba(17,24,39,.75);backdrop-filter:blur(6px);border:1px solid var(--border);
        border-radius:16px;padding:14px}
  .row{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px 0;border-top:1px dashed var(--border)}
  .row:first-child{border-top:0}
  .ipa{font-size:28px;font-weight:800}
  .desc{color:var(--muted);font-size:13px}
  .word{display:flex;flex-direction:column}
  .word small{color:var(--muted);font-size:12px}
  .btns{display:flex;gap:8px;flex-wrap:wrap}
  .muted{color:var(--muted)}
  details{margin-top:8px}
  summary{cursor:pointer;color:#9fd0ff}
  .rec-list{display:flex;flex-direction:column;gap:8px;margin-top:8px}
  .rec-item{display:flex;align-items:center;gap:8px;background:#0b1228;border:1px solid var(--border);padding:8px;border-radius:10px}
  audio{width:220px;max-width:60vw}
  .hint{font-size:12px;color:#9ca3af;margin-top:6px}
</style>
</head>
<body>
<div class="wrap">
  <h1>IPA Trainer â€” /É™/ /Éš/ /ÉË/ï¼ˆTTS + å½•éŸ³å­˜å‚¨ï¼‰</h1>
  <p class="sub">éŸ³æ ‡åŸéŸ³ç”¨ <b>Local</b>ï¼ˆä½ å·²æŠŠ mp3 æ”¾ä»“åº“æ ¹ç›®å½•ï¼‰ï¼›ç¤ºä¾‹å•è¯ç”¨ <b>TTS</b> æ’­æ”¾ã€‚å½•éŸ³ä¼šä¿å­˜åˆ°å½“å‰æµè§ˆå™¨ï¼ˆlocalStorageï¼‰ï¼Œä½ å¯éšæ—¶å›æ”¾ã€‚</p>

  <div class="toolbar">
    <span class="pill">Playback:
      <label><input type="radio" name="src" value="local" checked> Localï¼ˆéŸ³æ ‡åŸéŸ³ï¼‰</label>
      <label><input type="radio" name="src" value="tts"> TTSï¼ˆä»…ç¤ºä¾‹å•è¯ï¼‰</label>
    </span>
    <span class="pill">Voice: <select id="voice"></select></span>
    <span class="pill">Rate <input id="rate" type="range" min="0.7" max="1.1" step="0.05" value="0.85">
      <span id="rateV">0.85</span></span>
    <span class="pill">Pitch <input id="pitch" type="range" min="0.9" max="1.2" step="0.05" value="1.00">
      <span id="pitchV">1.00</span></span>
  </div>

  <div class="grid" id="grid"></div>

  <p class="hint">æç¤ºï¼šé¦–æ¬¡å½•éŸ³éœ€å…è®¸éº¦å…‹é£ï¼›åœ¨æ‰‹æœºç«¯è¯·é€šè¿‡ HTTPSï¼ˆGitHub Pagesï¼‰è®¿é—®ã€‚</p>

  <!-- éšè—çš„æ’­æ”¾å™¨ï¼šåªç”¨äºæ’­æ”¾â€œéŸ³æ ‡åŸéŸ³â€çš„æœ¬åœ° mp3 -->
  <audio id="phonemeAudio" preload="none"></audio>
</div>

<script>
/* ====== æ•°æ®ï¼šä¸‰ç»„éŸ³æ ‡ä¸ç¤ºä¾‹ï¼ˆå« IPAï¼‰ ====== */
const DATA = [
  {
    phoneme: '/É™/',
    desc: 'Schwaï¼šä¸­å¤®æ”¾æ¾ï¼ˆå¼±è¯»çš„ä¸­å…ƒéŸ³ï¼‰ã€‚',
    src: './us_phonetics_sound_above_2023feb.mp3', // ä½ æ”¾åœ¨ä»“åº“æ ¹ç›®å½•
    words: [
      {w:'about', ipa:'É™ËˆbaÊŠt'},
      {w:'banana', ipa:'bÉ™ËˆnÃ¦nÉ™'},
      {w:'sofa', ipa:'ËˆsoÊŠfÉ™'},
      {w:'open', ipa:'ËˆoÊŠpÉ™n'},
      {w:'problem', ipa:'ËˆprÉ‘ËblÉ™m'},
      {w:'synthesis', ipa:'ËˆsÉªnÎ¸É™sÉªs'},
      {w:'animal', ipa:'ËˆÃ¦nÉªmÉ™l'},
      {w:'president', ipa:'ËˆprezÉªdÉ™nt'},
      {w:'pupil', ipa:'ËˆpjuËpÉ™l'},
      {w:'bacon', ipa:'ËˆbeÉªkÉ™n'},
      {w:'lesson', ipa:'ËˆlesÉ™n'},
      {w:'pilot', ipa:'ËˆpaÉªlÉ™t'},
      {w:'circus', ipa:'ËˆsÉËkÉ™s'},
      {w:'medium', ipa:'ËˆmiËdiÉ™m'},
      {w:'support', ipa:'sÉ™ËˆpÉ”Ërt'},
      {w:'courageous', ipa:'kÉ™ËˆreÉªdÊ’É™s'},
      {w:'famous', ipa:'ËˆfeÉªmÉ™s'},
      {w:'humorous', ipa:'ËˆhjuËmÉ™rÉ™s'},
    ]
  },
  {
    phoneme: '/Éš/',
    desc: 'å¼±è¯»å·èˆŒï¼ˆr-colored å¼±è¯»ï¼‰ã€‚',
    src: './us_phonetics_sound_mother_2023feb.mp3', // ä½ æ”¾åœ¨ä»“åº“æ ¹ç›®å½•
    words: [
      {w:'better', ipa:'ËˆbetÌ¬Éš'},
      {w:'butter', ipa:'ËˆbÊŒtÌ¬Éš'},
      {w:'teacher', ipa:'ËˆtiËtÊƒÉš'},
      {w:'actor', ipa:'ËˆÃ¦k.tÉš'},
      {w:'doctor', ipa:'ËˆdÉ‘ËktÉš'},
      {w:'editor', ipa:'Ëˆed.Éª.tÌ¬Éš'},
      {w:'beggar', ipa:'ËˆbeÉ¡Éš'},
      {w:'burglar', ipa:'ËˆbÉËÉ¡lÉš'},
      {w:'collar', ipa:'ËˆkÉ‘ËlÉš'},
      {w:'culture', ipa:'ËˆkÊŒltÊƒÉš'},
      {w:'figure', ipa:'ËˆfÉªÉ¡jÉš'},
      {w:'pressure', ipa:'ËˆpreÊƒÉš'},
    ]
  },
  {
    phoneme: '/ÉË/',
    desc: 'é‡è¯»å·èˆŒï¼ˆr-colored é‡è¯»ï¼‰ã€‚',
    src: './us_phonetics_sound_mother_2023feb.mp3', // ä¸ /Éš/ åŒæºæ–‡ä»¶ï¼ˆä½ ç¡®è®¤çš„ï¼‰
    words: [
      {w:'her', ipa:'hÉË'},
      {w:'term', ipa:'tÉËm'},
      {w:'clerk', ipa:'klÉËk'},
      {w:'earn', ipa:'ÉËn'},
      {w:'earth', ipa:'ÉËÎ¸'},
      {w:'heard', ipa:'hÉËd'},
      {w:'bird', ipa:'bÉËd'},
      {w:'first', ipa:'ËˆfÉËst'},
      {w:'stir', ipa:'stÉË'},
      {w:'burn', ipa:'bÉËn'},
      {w:'nurse', ipa:'nÉËs'},
      {w:'turn', ipa:'tÉËn'},
      {w:'word', ipa:'wÉËd'},
      {w:'world', ipa:'wÉËld'},
      {w:'worse', ipa:'wÉËs'},
    ]
  }
];

/* ====== è¯­éŸ³åˆæˆï¼ˆTTSï¼‰ ====== */
const synth = window.speechSynthesis;
let voices = [];
const voiceSel = document.getElementById('voice');
const rateEl = document.getElementById('rate'), pitchEl = document.getElementById('pitch');
const rateV = document.getElementById('rateV'), pitchV = document.getElementById('pitchV');

function loadVoices(){
  voices = synth.getVoices().filter(v=>/en/i.test(v.lang));
  voiceSel.innerHTML='';
  voices.forEach((v,i)=>{
    const opt=document.createElement('option');
    opt.value=i; opt.textContent=`${v.name} â€” ${v.lang}`;
    if(/en-US/.test(v.lang) && /Google|Microsoft|Samantha|Natural|Neural/i.test(v.name)) opt.selected=true;
    voiceSel.appendChild(opt);
  });
}
loadVoices();
if (typeof speechSynthesis!=='undefined'){ speechSynthesis.onvoiceschanged=loadVoices; }

rateEl.oninput=()=>rateV.textContent=Number(rateEl.value).toFixed(2);
pitchEl.oninput=()=>pitchV.textContent=Number(pitchEl.value).toFixed(2);

function speakWord(text){
  const u = new SpeechSynthesisUtterance(text);
  const v = voices[voiceSel.value|0] || voices.find(x=>/en-US/i.test(x.lang)) || voices[0];
  if (v){ u.voice=v; u.lang=v.lang; } else { u.lang='en-US'; }
  u.rate=parseFloat(rateEl.value); u.pitch=parseFloat(pitchEl.value);
  speechSynthesis.cancel(); // ä¿è¯åªæ’­ä¸€æ¬¡
  speechSynthesis.speak(u);
}

/* ====== æ’­æ”¾æº ====== */
function mode(){ return document.querySelector('input[name="src"]:checked').value; }

/* ====== DOM æ¸²æŸ“ ====== */
const grid = document.getElementById('grid');
const phonemeAudio = document.getElementById('phonemeAudio');

function render(){
  grid.innerHTML = '';
  DATA.forEach(block=>{
    const card = document.createElement('section');
    card.className='card';

    const head = document.createElement('div');
    head.className='row';
    head.innerHTML = `
      <div>
        <div class="ipa">${block.phoneme}</div>
        <div class="desc">${block.desc}</div>
      </div>
      <div class="btns">
        <button class="primary" data-phoneme="${block.phoneme}">ğŸ”Š éŸ³æ ‡åŸéŸ³</button>
      </div>
    `;
    card.appendChild(head);

    block.words.forEach(item=>{
      const row = document.createElement('div');
      row.className='row';
      row.innerHTML = `
        <div class="word">
          <strong>${item.w}</strong>
          <small>/${item.ipa}/</small>
        </div>
        <div class="btns">
          <button class="primary" data-play="${item.w}">ğŸ”Š æ’­æ”¾</button>
          <button class="success" data-rec="${item.w}">ğŸ™ å½•éŸ³å¹¶ä¿å­˜</button>
        </div>
      `;
      // å½•éŸ³åˆ—è¡¨ï¼ˆå¯æŠ˜å ï¼‰
      const details = document.createElement('details');
      details.innerHTML = `
        <summary>æˆ‘çš„å½•éŸ³ï¼ˆ${item.w}ï¼‰</summary>
        <div class="rec-list" id="rec-${sanitize(item.w)}"></div>
      `;
      card.appendChild(row);
      card.appendChild(details);

      // åˆæ¬¡æ¸²æŸ“å·²å­˜å½•éŸ³
      renderRecordings(item.w);
    });

    grid.appendChild(card);
  });
}
render();

/* ====== äº¤äº’ï¼šæ’­æ”¾ éŸ³æ ‡åŸéŸ³ / å•è¯ï¼ˆTTSï¼‰ ====== */
grid.addEventListener('click', async (e)=>{
  const ph = e.target.getAttribute('data-phoneme');
  const w  = e.target.getAttribute('data-play');
  const r  = e.target.getAttribute('data-rec');

  if (ph){
    // ä»…ç”¨ Local æ’­æ”¾éŸ³æ ‡åŸéŸ³ï¼ˆæ¥è‡ªæ ¹ç›®å½• mp3ï¼‰
    const block = DATA.find(x=>x.phoneme===ph);
    if (!block) return;
    try{
      phonemeAudio.src = block.src;
      phonemeAudio.currentTime = 0;
      await phonemeAudio.play();
    }catch(err){
      console.warn(err);
      alert('æ— æ³•æ’­æ”¾éŸ³æ ‡åŸéŸ³ï¼šè¯·ç¡®è®¤ mp3 å·²æ”¾åœ¨ä»“åº“æ ¹ç›®å½•å¹¶å…è®¸éŸ³é¢‘æ’­æ”¾ã€‚');
    }
  }

  if (w){
    // å•è¯ç”¨ TTSï¼ˆä¸ä¾èµ– mp3ï¼‰
    if (mode()==='tts' || mode()==='local'){ // ä¸¤ç§æ¨¡å¼ä¸‹å•è¯éƒ½ç”¨ TTSï¼Œä¿æŒä¸€è‡´
      speakWord(w);
    }
  }

  if (r){
    startRecordingFor(r);
  }
});

/* ====== å½•éŸ³å¹¶ä¿å­˜åˆ° localStorageï¼ˆæ¯æ¬¡çº¦ 2 ç§’ï¼‰ ====== */
let mediaStream, mediaRecorder, chunks=[];
async function ensureMic(){
  if (mediaStream) return mediaStream;
  mediaStream = await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:true,noiseSuppression:true}});
  return mediaStream;
}
function sanitize(name){ return name.toLowerCase().replace(/[^a-z0-9_-]/g,'_'); }

async function startRecordingFor(word){
  try{
    await ensureMic(); chunks=[];
    const mime =
      MediaRecorder.isTypeSupported('audio/webm;codecs=opus') ? 'audio/webm;codecs=opus' :
      (MediaRecorder.isTypeSupported('audio/mp4') ? 'audio/mp4' : '');

    mediaRecorder = new MediaRecorder(mediaStream, mime?{mimeType:mime}:{} );
    mediaRecorder.ondataavailable = e=>{ if(e.data.size) chunks.push(e.data); };
    mediaRecorder.onstop = async () => {
      const blob = new Blob(chunks, {type: mime || 'audio/webm;codecs=opus'});
      console.log("å½•éŸ³å®Œæˆï¼Œæ ¼å¼ï¼š", blob.type, " å¤§å°ï¼š", blob.size);
      try {
          const dataUrl = await blobToDataURL(blob);
          saveRecording(word, {ts: Date.now(), mime: blob.type, dataUrl});
          renderRecordings(word);
      } catch (err) {
          console.error("å½•éŸ³ä¿å­˜å¤±è´¥ï¼š", err);
          alert("å½•éŸ³ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚");
      }
    };
    mediaRecorder.start();
    // å›ºå®š 2 ç§’
    setTimeout(()=> mediaRecorder.stop(), 2000);
  }catch(err){
    console.error(err);
    alert('æ— æ³•å½•éŸ³ï¼šè¯·å…è®¸éº¦å…‹é£ï¼›æ‰‹æœºç«¯è¯·ç”¨ HTTPSï¼ˆGitHub Pagesï¼‰è®¿é—®ã€‚');
  }
}

function blobToDataURL(blob){
  return new Promise(res=>{
    const fr = new FileReader();
    fr.onload = ()=>res(fr.result);
    fr.readAsDataURL(blob);
  });
}

/* ====== æœ¬åœ°å­˜å‚¨ï¼ˆlocalStorageï¼‰ï¼šæŒ‰å•è¯ä¿å­˜å¤šæ¡ ====== */
function keyOf(word){ return 'rec_' + sanitize(word); }

function loadRecordings(word){
  try{
    const raw = localStorage.getItem(keyOf(word));
    return raw ? JSON.parse(raw) : [];
  }catch(_){ return []; }
}

function saveRecording(word, rec){
  const arr = loadRecordings(word);
  arr.unshift(rec);
  // å¯é€‰ï¼šåªä¿ç•™æœ€è¿‘ 10 æ¡
  const kept = arr.slice(0, 10);
  localStorage.setItem(keyOf(word), JSON.stringify(kept));
}

function deleteRecording(word, ts){
  const arr = loadRecordings(word).filter(x=>x.ts!==ts);
  localStorage.setItem(keyOf(word), JSON.stringify(arr));
}

function renderRecordings(word){
  const list = document.getElementById('rec-' + sanitize(word));
  if (!list) return;
  const items = loadRecordings(word);
  list.innerHTML = '';
  if (items.length===0){
    list.innerHTML = '<div class="muted">æš‚æ— å½•éŸ³</div>';
    return;
  }
  items.forEach(item=>{
    const div = document.createElement('div');
    div.className = 'rec-item';
    const time = new Date(item.ts).toLocaleString();
    div.innerHTML = `
      <span class="muted">${time}</span>
      <audio controls src="${item.dataUrl}"></audio>
      <button class="warn" data-del="${item.ts}" data-word="${word}">åˆ é™¤</button>
    `;
    list.appendChild(div);
  });

  // ç»‘å®šåˆ é™¤
  list.querySelectorAll('button[data-del]').forEach(btn=>{
    btn.onclick = ()=>{
      const ts = Number(btn.getAttribute('data-del'));
      const w  = btn.getAttribute('data-word');
      deleteRecording(w, ts);
      renderRecordings(w);
    };
  });
}

/* ====== åˆå§‹åŒ–ï¼šUI å°äº¤äº’ ====== */
document.getElementById('rate').addEventListener('input', ()=> rateV.textContent = Number(rateEl.value).toFixed(2));
document.getElementById('pitch').addEventListener('input', ()=> pitchV.textContent = Number(pitchEl.value).toFixed(2));
</script>
</body>
</html>
