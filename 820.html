<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>美式元音播放器（ʌ / ɑː / ɑːr + 录音回放）</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#111827; --panel:#0f172a; --card:#121826; --muted:#9aa4b2; --text:#e5e7eb;
    --blue:#2f80ed; --blue2:#1c65c8; --hlIpa:#3ddc97; --hlWord:#fff3bf; --hlBorder:#f59e0b;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; padding:14px; font-family:'Noto Sans',system-ui,-apple-system,Segoe UI,Roboto,Arial,"PingFang SC","Microsoft YaHei",sans-serif;
    color:var(--text); background:linear-gradient(180deg,#0d1320,#0b1220 40%,#0a0f1a);
  }
  h1{font-size:22px; margin:6px 0 10px; text-align:center}
  .toolbar{
    position:sticky; top:0; z-index:9; padding:10px; margin:0 auto 12px; max-width:980px;
    background:rgba(15,23,42,.9); border:1px solid rgba(148,163,184,.15); border-radius:14px;
    display:grid; gap:10px; grid-template-columns:1fr; }
  @media (min-width:760px){ .toolbar{grid-template-columns:1fr 1fr} }
  .row{display:flex; flex-wrap:wrap; align-items:center; gap:10px}
  label{font-size:12px; color:var(--muted)}
  select, input[type=range]{
    border:1px solid rgba(148,163,184,.25); background:#0b1220; color:var(--text); padding:8px 10px; border-radius:10px;
  }
  .btn{background:var(--blue); color:#fff; border:none; border-radius:12px; padding:10px 14px; font-weight:700; cursor:pointer}
  .btn:hover{background:var(--blue2)}
  .btn:active{transform:scale(.98)}
  .tip{max-width:980px; margin:0 auto 10px; font-size:12px; color:var(--muted); text-align:center}

  .vowel{background:var(--card); padding:14px; border-radius:14px; margin:10px auto; max-width:980px; border:2px solid transparent}
  .vowel.active{border-color:var(--hlBorder)}
  .ipaLine{display:flex; align-items:center; gap:10px; margin-bottom:8px}
  .ipaBtn{font-size:26px; font-weight:700; color:var(--hlIpa); cursor:pointer}
  .ipaTip{font-size:12px; color:#cfe6ff}

  .section{margin-top:8px; border-top:1px dashed rgba(148,163,184,.25); padding-top:8px}
  .secTitle{font-size:13px; color:#a8ffef; margin-bottom:6px}

  .examples{display:grid; grid-template-columns:repeat(auto-fill,minmax(280px,1fr)); gap:8px}
  .word-item{
    display:grid; grid-template-columns:auto 1fr auto auto auto; gap:6px; align-items:center;
    background:rgba(255,255,255,.06); border-radius:12px; padding:8px
  }
  .word-item.active{background: var(--hlWord); color:#222; box-shadow:0 0 0 2px rgba(245,158,11,.25) inset}
  .word-text{font-size:16px; font-weight:700}
  .word-ipa{font-size:12px; color:var(--muted)}
  .word-zh{font-size:12px; color:#ffd166}
  .play-btn, .rec-btn, .replay-btn{
    background:var(--blue); color:#fff; border:none; border-radius:8px; padding:6px 10px; font-size:12px; display:flex; align-items:center; gap:6px; cursor:pointer;
  }
  .play-btn:hover, .rec-btn:hover, .replay-btn:hover{background:var(--blue2)}
  .play-icon{font-weight:700}

  .foot{max-width:980px; margin:12px auto; color:var(--muted); font-size:12px; text-align:center}
</style>
</head>
<body>
  <h1>美式元音播放器（ʌ / ɑː / ɑːr）</h1>

  <div class="toolbar">
    <div class="row">
      <label>英文音色：</label><select id="enVoice" style="min-width:180px"></select>
      <label>中文音色：</label><select id="zhVoice" style="min-width:180px"></select>
    </div>
    <div class="row">
      <label>语速：</label><input id="rate" type="range" min="0.6" max="1.6" step="0.05" value="1">
      <label>音量：</label><input id="volume" type="range" min="0" max="1" step="0.05" value="1">
      <button class="btn" id="autoPlay">自动播放全部</button>
      <button class="btn" id="stop">停止</button>
    </div>
  </div>

  <p class="tip">点击<strong>音标</strong>：中文要点 → 播放 GitHub 原音；点击<strong>例词右侧蓝色按钮</strong>：英文 → <b>1 秒</b> → 中文 → <b>1 秒</b> → 英文。自动播放按你给的顺序依次播放，播放中高亮当前音标与单词。每个单词都支持<strong>🎙️录音/🔁回放</strong>，便于自测发音。</p>

  <div id="root"></div>

  <div class="foot">音标音频来自你的 GitHub：<code>wyy1054663844-alt/phonics8.13</code>（规则：<code>ː → _long</code>，例：<code>ɑː → ɑ_long.mp3</code>）。</div>

<script>
/* ===================== 基础配置（兼容版） ===================== */
var BASE = "https://wyy1054663844-alt.github.io/phonics8.13/";
function ipaToFile(ipa){
  var name = ipa.replace("ː","_long");
  return BASE + encodeURIComponent(name) + ".mp3";
}
function wait(ms){ return new Promise(function(res){ setTimeout(res, ms); }); }

/* ===================== 发音要点（中文） ===================== */
var IPA_TIP = {
  "ʌ":"短元音，发音短促有力，舌位低平靠后，唇形自然放松。",
  "ɑː":"美式长元音，发音长而饱满，舌位靠后，嘴巴张大，与英式发音有所区别。",
  "ɑːr":"卷舌长元音，重读，发音时舌尖上卷，音长稍延长。",
  // 原有的音标也保留了，防止混淆
  "ə":"轻读元音（schwa），短而轻，口型放松、舌位居中，多出现在非重读音节。",
  "ɚ":"卷舌的弱读元音（儿化），短而轻，多见词尾 -er。",
  "ɝː":"卷舌长元音，重读，音长稍延长，舌尖上卷接近上腭。"
};

/* ===================== 数据（严格按你的分组与顺序） ===================== */
/* 结构：groups -> {ipa, sections:[{title, items:[{w, ipa, zh}]}]} */
var GROUPS = [
  { ipa:"ʌ", sections:[
      { title:"u", items:[
        {w:"sun",     ipa:"/sʌn/",     zh:"太阳"},
        {w:"cup",     ipa:"/kʌp/",     zh:"杯子"},
        {w:"but",     ipa:"/bʌt/",     zh:"但是"}
      ]},
      { title:"o", items:[
        {w:"son",     ipa:"/sʌn/",     zh:"儿子"},
        {w:"comfort", ipa:"/ˈkʌm.fɚt/", zh:"舒适"},
        {w:"money",   ipa:"/ˈmʌn.i/",   zh:"金钱"}
      ]},
      { title:"ou", items:[
        {w:"young",   ipa:"/jʌŋ/",     zh:"年轻的"},
        {w:"double",  ipa:"/ˈdʌb.əl/",  zh:"双倍"},
        {w:"country", ipa:"/ˈkʌn.tri/", zh:"国家"}
      ]},
      { title:"oo", items:[
        {w:"blood",   ipa:"/blʌd/",    zh:"血液"},
        {w:"flood",   ipa:"/flʌd/",    zh:"洪水"}
      ]}
  ]},
  { ipa:"ɑː", sections:[
      { title:"a", items:[
        {w:"father", ipa:"/ˈfɑː.ðɚ/",  zh:"父亲"},
        {w:"watch",  ipa:"/wɑːtʃ/",    zh:"手表"},
        {w:"wasp",   ipa:"/wɑːsp/",    zh:"黄蜂"}
      ]},
      { title:"al", items:[
        {w:"almond", ipa:"/ˈɑːl.mənd/", zh:"杏仁"},
        {w:"balm",   ipa:"/bɑːm/",     zh:"香油"},
        {w:"palm",   ipa:"/pɑːm/",     zh:"手掌"}
      ]},
      { title:"au", items:[
        {w:"because", ipa:"/bɪˈkɑːz/",  zh:"因为"},
        {w:"clause",  ipa:"/klɑːz/",    zh:"从句"},
        {w:"paunch",  ipa:"/pɑːntʃ/",   zh:"大肚腩"}
      ]},
      { title:"aw", items:[
        {w:"drawn",  ipa:"/drɑːn/",    zh:"画（过去式）"},
        {w:"awning", ipa:"/ˈɑː.nɪŋ/",   zh:"遮阳篷"},
        {w:"law",    ipa:"/lɑː/",      zh:"法律"}
      ]},
      { title:"o", items:[
        {w:"hot",    ipa:"/hɑːt/",     zh:"热的"},
        {w:"dog",    ipa:"/dɑːɡ/",     zh:"狗"},
        {w:"log",    ipa:"/lɑːɡ/",     zh:"原木"}
      ]},
      { title:"ough", items:[
        {w:"bought", ipa:"/bɑːt/",    zh:"买（过去式）"},
        {w:"thought",ipa:"/θɑːt/",    zh:"想（过去式）"},
        {w:"fought", ipa:"/fɑːt/",    zh:"打（过去式）"}
      ]}
  ]},
  { ipa:"ɑːr", sections:[
      { title:"ar", items:[
        {w:"car",   ipa:"/kɑːr/",  zh:"汽车"},
        {w:"far",   ipa:"/fɑːr/",  zh:"远的"},
        {w:"start", ipa:"/stɑːrt/", zh:"开始"}
      ]}
  ]}
];

/* ===================== 语音引擎（兼容） ===================== */
var synth = window.speechSynthesis;
var currentAudio = null;
var stopFlag = false;
var enVoices = []; var zhVoices = [];

function pickVoice(lang, selectId){
  try{
    var list = synth.getVoices() || [];
    var i, arr = [];
    for(i=0;i<list.length;i++){
      var v = list[i];
      if(!v || !v.lang) continue;
      if(lang === 'en'){ if(/en[-_]/i.test(v.lang)) arr.push(v); }
      else{ if(/^zh/i.test(v.lang) || /cmn/i.test(v.lang)) arr.push(v); }
    }
    if(lang === 'en') enVoices = arr; else zhVoices = arr;
    var sel = document.getElementById(selectId);
    var html = "";
    for(i=0;i<arr.length;i++){ html += '<option value="'+i+'">'+ arr[i].name +' ('+ arr[i].lang +')</option>'; }
    sel.innerHTML = html;
    if(lang==='en'){
      var idxUS = arr.findIndex(function(v){return /en-US/i.test(v.lang);});
      if(idxUS>=0) sel.value = String(idxUS);
    }else{
      var idxCN = arr.findIndex(function(v){return /zh-CN/i.test(v.lang);});
      if(idxCN>=0) sel.value = String(idxCN);
    }
  }catch(e){}
}
function loadVoices(){ pickVoice('en','enVoice'); pickVoice('zh','zhVoice'); }
if (synth && typeof synth.onvoiceschanged !== 'undefined'){ synth.onvoiceschanged = loadVoices; }
setTimeout(loadVoices, 200);

function currentRate(){ return Math.max(0.1, parseFloat(document.getElementById('rate').value||'1')); }
function currentVol(){  var v = parseFloat(document.getElementById('volume').value||'1'); return (v>=0&&v<=1)?v:1; }

function getVoice(lang){
  var sel = document.getElementById(lang==='en'?'enVoice':'zhVoice');
  var idx = parseInt(sel.value||'-1',10);
  var arr = (lang==='en')? enVoices : zhVoices;
  return (arr && arr[idx]) ? arr[idx] : null;
}

function speak(text, lang){
  return new Promise(function(resolve){
    try{
      var u = new SpeechSynthesisUtterance(text);
      u.lang = (lang==='en')? 'en-US':'zh-CN';
      u.rate = currentRate();
      u.volume = currentVol();
      var v = getVoice(lang);
      if(v) u.voice = v;
      u.onend = resolve;
      synth.speak(u);
    }catch(e){ resolve(); }
  });
}

function playAudio(url){
  return new Promise(function(resolve){
    try{ if(currentAudio){ currentAudio.pause(); currentAudio=null; } }catch(e){}
    var a = new Audio(url);
    currentAudio = a;
    a.onended = function(){ currentAudio=null; resolve(); };
    a.onerror = function(){ currentAudio=null; resolve(); };
    a.play().catch(function(){ resolve(); });
  });
}
// --- iOS WebAudio unlock（保持原逻辑） ---
var unlocked = false;
function unlockAudioOnce(){
  return new Promise(function(resolve){
    if(unlocked){ resolve(); return; }
    var silent = new SpeechSynthesisUtterance(" ");
    silent.volume = 0; silent.rate = 1; silent.lang = 'en-US';
    silent.onend = function(){
      var b = new Audio('data:audio/mp3;base64,//uQZAAAAAAAAAAAAAAAAAAAA');
      b.play().catch(function(){}).finally(function(){ unlocked = true; resolve(); });
    };
    try{ synth.speak(silent); }catch(e){ unlocked = true; resolve(); }
  });
}

/* ===================== 高亮工具 ===================== */
function clearHighlights(){
  document.querySelectorAll('.vowel').forEach(function(el){ el.classList.remove('active'); });
  document.querySelectorAll('.word-item').forEach(function(el){ el.classList.remove('active'); });
}
function highlightIpa(ipa){
  clearHighlights();
  var el = document.querySelector('.vowel[data-ipa="'+ ipa.replace(/"/g,'\\"') +'"]');
  if(el) el.classList.add('active');
}
function highlightWord(ipa, word){
  document.querySelectorAll('.word-item').forEach(function(el){ el.classList.remove('active'); });
  var sel = '.word-item[data-ipa="'+ ipa.replace(/"/g,'\\"') +'"][data-word="'+ word.replace(/"/g,'\\"') +'"]';
  var el = document.querySelector(sel);
  if(el) el.classList.add('active');
}

/* ===================== 播放序列 ===================== */
function stopAll(){
  stopFlag = true;
  try{ synth.cancel(); }catch(e){}
  try{ if(currentAudio){ currentAudio.pause(); currentAudio=null; } }catch(e){}
  clearHighlights();
}
function playIpaWithTip(ipa){
  return new Promise(async function(resolve){
    stopFlag = false;
    highlightIpa(ipa);
    await speak(IPA_TIP[ipa]||"发音提示", 'zh');
    if(stopFlag){ resolve(); return; }
    await playAudio(ipaToFile(ipa));
    resolve();
  });
}
function playWordSeq(ipa, word, zh){
  return new Promise(async function(resolve){
    stopFlag = false;
    highlightWord(ipa, word);
    await speak(word, 'en');
    if(stopFlag){ resolve(); return; }
    await wait(1000);
    await speak(zh, 'zh');
    if(stopFlag){ resolve(); return; }
    await wait(1000);
    await speak(word, 'en');
    resolve();
  });
}

/* ===================== 录音器（iOS 友好：WebAudio + WAV） ===================== */
var recorder = (function(){
  var ctx, stream, source, processor, recording = false, buffers = [], sampleRate = 44100, currentKey = null;
  var recordings = new Map(); // wordKey -> Blob(audio/wav)

  async function ensureContext(){
    if(!ctx){
      var AC = window.AudioContext || window.webkitAudioContext;
      ctx = AC ? new AC() : null;
    }
    if(ctx && ctx.state === 'suspended'){ try{ await ctx.resume(); }catch(e){} }
    return ctx;
  }
  async function ensureMic(){
    if(stream) return stream;
    stream = await navigator.mediaDevices.getUserMedia({audio:true});
    return stream;
  }
  function createNode(){
    destroyNode();
    source = ctx.createMediaStreamSource(stream);
    // 4096 帧，单声道
    processor = ctx.createScriptProcessor(4096, 1, 1);
    processor.onaudioprocess = function(e){
      if(!recording) return;
      var ch = e.inputBuffer.getChannelData(0);
      // 复制到新 Float32Array，避免后续复用
      buffers.push(new Float32Array(ch));
    };
    source.connect(processor);
    processor.connect(ctx.destination);
  }
  function destroyNode(){
    if(processor){ try{ processor.disconnect(); }catch(e){} processor = null; }
    if(source){ try{ source.disconnect(); }catch(e){} source = null; }
  }
  function encodeWAV(float32Data, sRate){
    // 合并
    var length = 0;
    for(var i=0;i<float32Data.length;i++){ length += float32Data[i].length; }
    var data = new Float32Array(length);
    var offset = 0;
    for(var j=0;j<float32Data.length;j++){ data.set(float32Data[j], offset); offset += float32Data[j].length; }
    // 转 16-bit PCM
    var bytesPerSample = 2;
    var blockAlign = 1 * bytesPerSample;
    var buffer = new ArrayBuffer(44 + data.length * bytesPerSample);
    var view = new DataView(buffer);

    function writeString(v, off, str){ for(var i=0;i<str.length;i++) v.setUint8(off+i, str.charCodeAt(i)); }
    function floatTo16BitPCM(output, offset, input){
      for (var i=0; i<input.length; i++, offset+=2) {
        var s = Math.max(-1, Math.min(1, input[i]));
        output.setInt16(offset, s<0 ? s*0x8000 : s*0x7FFF, true);
      }
    }
    // WAV 头
    writeString(view, 0, 'RIFF');
    view.setUint32(4, 36 + data.length * bytesPerSample, true);
    writeString(view, 8, 'WAVE');
    writeString(view, 12, 'fmt ');
    view.setUint32(16, 16, true); // PCM
    view.setUint16(20, 1, true);  // Linear PCM
    view.setUint16(22, 1, true);  // mono
    view.setUint32(24, sRate, true);
    view.setUint32(28, sRate * blockAlign, true);
    view.setUint16(32, blockAlign, true);
    view.setUint16(34, 8 * bytesPerSample, true);
    writeString(view, 36, 'data');
    view.setUint32(40, data.length * bytesPerSample, true);
    // PCM 数据
    floatTo16BitPCM(view, 44, data);

    return new Blob([view], {type:'audio/wav'});
  }

  return {
    async start(wordKey){
      // 终止所有 TTS/音频，避免串音
      stopAll();
      var c = await ensureContext();
      if(!c) throw new Error('当前浏览器不支持 AudioContext');
      await unlockAudioOnce();
      await ensureMic();
      createNode();
      buffers = [];
      currentKey = wordKey;
      recording = true;
    },
    async stop(){
      recording = false;
      var blob = encodeWAV(buffers, ctx.sampleRate || sampleRate);
      recordings.set(currentKey, blob);
      destroyNode(); // 释放节点（保留流以便下次更快启动）
      return blob;
    },
    has(wordKey){ return recordings.has(wordKey); },
    play(wordKey){
      var blob = recordings.get(wordKey);
      if(!blob) throw new Error('该单词还没有录音');
      var url = URL.createObjectURL(blob);
      var a = new Audio(url);
      a.play();
    }
  };
})();

/* ===================== 页面渲染 ===================== */
function render(){
  var root = document.getElementById('root');
  root.innerHTML = '';
  GROUPS.forEach(function(g){
    var card = document.createElement('div');
    card.className = 'vowel';
    card.setAttribute('data-ipa', g.ipa);

    var line = document.createElement('div');
    line.className = 'ipaLine';
    var ipaBtn = document.createElement('span');
    ipaBtn.className = 'ipaBtn';
    ipaBtn.textContent = g.ipa;
    ipaBtn.title = '点击：中文要点 → 播放该音标原音';
    ipaBtn.addEventListener('click', function(){ stopAll(); playIpaWithTip(g.ipa); });

    var tip = document.createElement('span');
    tip.className = 'ipaTip';
    tip.textContent = IPA_TIP[g.ipa] || '发音提示';

    line.appendChild(ipaBtn); line.appendChild(tip);
    card.appendChild(line);

    g.sections.forEach(function(sec){
      var secBox = document.createElement('div'); secBox.className='section';
      var title = document.createElement('div'); title.className='secTitle'; title.textContent = sec.title;
      secBox.appendChild(title);

      var list = document.createElement('div'); list.className='examples';
      sec.items.forEach(function(it){
        var row = document.createElement('div'); row.className='word-item';
        row.setAttribute('data-ipa', g.ipa); row.setAttribute('data-word', it.w);

        var t1 = document.createElement('div'); t1.className='word-text'; t1.textContent = it.w;
        var t2 = document.createElement('div'); t2.className='word-ipa'; t2.textContent = it.ipa;
        var t3 = document.createElement('div'); t3.className='word-zh';  t3.textContent  = it.zh;

        // 播放（英→1s→中→1s→英）
        var playBtn = document.createElement('button'); playBtn.className='play-btn';
        playBtn.innerHTML = '<span class="play-icon">▶</span>播放';
        playBtn.addEventListener('click', function(){ stopAll(); playWordSeq(g.ipa, it.w, it.zh); });

        // 录音
        var recBtn = document.createElement('button'); recBtn.className='rec-btn'; recBtn.textContent = '🎙️录音';
        var recState = { recording:false };
        recBtn.addEventListener('click', async function(){
          try{
            if(!recState.recording){
              await recorder.start(it.w);
              recState.recording = true;
              recBtn.textContent = '⏹停止';
            }else{
              await recorder.stop();
              recState.recording = false;
              recBtn.textContent = '🎙️录音';
            }
          }catch(err){
            recState.recording = false;
            recBtn.textContent = '🎙️录音';
            alert('录音失败：' + (err && err.message ? err.message : err));
          }
        });

        // 回放
        var replayBtn = document.createElement('button'); replayBtn.className='replay-btn'; replayBtn.textContent = '🔁回放';
        replayBtn.addEventListener('click', function(){
          try{
            if(!recorder.has(it.w)) { alert('该单词还没有录音'); return; }
            recorder.play(it.w);
          }catch(err){
            alert('回放失败：' + (err && err.message ? err.message : err));
          }
        });

        row.appendChild(t1); row.appendChild(t2); row.appendChild(t3);
        row.appendChild(playBtn); row.appendChild(recBtn); row.appendChild(replayBtn);
        list.appendChild(row);
      });

      secBox.appendChild(list);
      card.appendChild(secBox);
    });

    root.appendChild(card);
  });
}
render();

/* ===================== 自动播放全部 ===================== */
document.getElementById('autoPlay').addEventListener('click', async function(){
  stopAll(); stopFlag=false;
  await unlockAudioOnce(); // iOS 解锁
  for(var i=0;i<GROUPS.length;i++){
    if(stopFlag) break;
    var g = GROUPS[i];
    await playIpaWithTip(g.ipa);
    if(stopFlag) break;
    for(var j=0;j<g.sections.length;j++){
      if(stopFlag) break;
      var sec = g.sections[j];
      for(var k=0;k<sec.items.length;k++){
        if(stopFlag) break;
        var it = sec.items[k];
        await wait(250);
        await playWordSeq(g.ipa, it.w, it.zh);
      }
    }
  }
  clearHighlights();
});

document.getElementById('stop').addEventListener('click', stopAll);
</script>
</body>
</html>