<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>IPA Trainer â€” /É™/ /Éš/ /ÉË/</title>
<style>
  :root{
    --bg:#0b1022; --bg2:#0f172a; --card:#0f172a; --border:#1f2937;
    --txt:#e5e7eb; --muted:#9ca3af; --primary:#60a5fa; --green:#22c55e; --blue:#3b82f6; --red:#ef4444;
  }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,var(--bg),var(--bg2) 30%,var(--bg));color:var(--txt);
       font-family: system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif;}
  .wrap{max-width:1100px;margin:24px auto;padding:16px}
  h1{margin:0 0 6px;font-weight:800}
  .sub{color:var(--muted);margin:0 0 16px}
  .toolbar{display:flex;flex-wrap:wrap;gap:8px;margin:12px 0 18px}
  .pill{display:inline-flex;align-items:center;gap:8px;background:#0b1228;border:1px solid var(--border);
        padding:8px 10px;border-radius:12px}
  select,button,input[type="range"]{appearance:none}
  button{border:0;border-radius:10px;padding:8px 12px;font-weight:700;cursor:pointer;color:#071426;background:#2d3648}
  button.primary{background:var(--primary);color:#041422}
  button.secondary{background:#22d3ee;color:#052430}
  button.success{background:var(--green);color:#06240b}
  button.warn{background:var(--red);color:#3a0a0a}
  .grid{display:grid;grid-template-columns:repeat(3,minmax(260px,1fr));gap:14px}
  @media (max-width:980px){ .grid{grid-template-columns:1fr} }
  .card{background:rgba(17,24,39,.75);backdrop-filter:blur(6px);border:1px solid var(--border);
        border-radius:16px;padding:14px}
  .row{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:8px 0;border-top:1px dashed var(--border)}
  .row:first-child{border-top:0}
  .ipa{font-size:28px;font-weight:800}
  .desc{color:var(--muted);font-size:13px}
  .word{display:flex;flex-direction:column}
  .word small{color:var(--muted)}
  .btns{display:flex;gap:8px;flex-wrap:wrap}
  .muted{color:var(--muted)}
  .score{font-weight:800}
  .hint{font-size:12px;color:var(--muted)}
  .hidden{display:none}
  .chip{border:1px solid var(--border);padding:4px 8px;border-radius:999px;font-size:12px;color:var(--muted)}
</style>
</head>
<body>
<div class="wrap">
  <h1>IPA Trainer â€” /É™/ /Éš/ /ÉË/</h1>
  <p class="sub">ç‚¹å‡» <b>ğŸ”Š æ’­æ”¾</b> â†’ è·Ÿè¯» â†’ ç‚¹å‡» <b>ğŸ™ å½•éŸ³</b> è‡ªæ£€ã€‚é»˜è®¤ä½¿ç”¨ <span class="chip">TTS</span>ï¼ˆç¾å¼ã€æ…¢é€Ÿï¼‰ã€‚</p>

  <div class="toolbar">
    <span class="pill">Playback Source:
      <label><input type="radio" name="src" value="tts" checked> TTS</label>
      <label><input type="radio" name="src" value="local"> Local</label>
    </span>
    <span class="pill">Voice: <select id="voice"></select></span>
    <span class="pill">Rate <input id="rate" type="range" min="0.6" max="1.1" step="0.05" value="0.75">
      <span id="rateV">0.75</span></span>
    <span class="pill">Pitch <input id="pitch" type="range" min="0.8" max="1.3" step="0.05" value="1.00">
      <span id="pitchV">1.00</span></span>
    <button id="autoBtn" class="secondary">â–¶ è‡ªåŠ¨æ’­æ”¾æœ¬é¡µæ‰€æœ‰å•è¯</button>
  </div>

  <!-- ä¸‰ç»„éŸ³æ ‡ -->
  <div class="grid">
    <!-- /É™/ -->
    <section class="card">
      <div class="row">
        <div>
          <div class="ipa">/É™/</div>
          <div class="desc">Schwaï¼šä¸­å¤®ã€æ”¾æ¾ã€çŸ­ä¿ƒã€‚å¦‚ <i>about</i> å¼€å¤´ã€‚</div>
          <div class="hint">å£å‹æ¾ã€èˆŒä¸­éƒ¨æ”¾æ¾ã€æ—¶é•¿çŸ­ã€‚</div>
        </div>
        <button class="primary" data-type="phoneme" data-key="É™">ğŸ”Š æ’­æ”¾</button>
      </div>
      <div class="row">
        <div class="word"><strong>about</strong> <small>/É™ËˆbaÊŠt/</small></div>
        <div class="btns">
          <button class="primary" data-type="word" data-key="about">ğŸ”Š</button>
          <button class="success rec" data-key="about">ğŸ™ å½•éŸ³</button>
        </div>
      </div>
      <div class="row">
        <div class="word"><strong>banana</strong> <small>/bÉ™ËˆnÃ¦nÉ™/</small></div>
        <div class="btns">
          <button class="primary" data-type="word" data-key="banana">ğŸ”Š</button>
          <button class="success rec" data-key="banana">ğŸ™ å½•éŸ³</button>
        </div>
      </div>
      <div class="row">
        <div class="word"><strong>sofa</strong> <small>/ËˆsoÊŠfÉ™/</small></div>
        <div class="btns">
          <button class="primary" data-type="word" data-key="sofa">ğŸ”Š</button>
          <button class="success rec" data-key="sofa">ğŸ™ å½•éŸ³</button>
        </div>
      </div>
    </section>

    <!-- /Éš/ -->
    <section class="card">
      <div class="row">
        <div>
          <div class="ipa">/Éš/</div>
          <div class="desc">å¼±è¯»å·èˆŒï¼›çŸ­è€Œè½»ã€‚å¦‚ <i>better</i> è¯å°¾ã€‚</div>
          <div class="hint">èˆŒå°–å¾®å·æˆ–èˆŒæ ¹æŠ¬èµ·ï¼ŒåŠ›åº¦è½»ã€‚</div>
        </div>
        <button class="primary" data-type="phoneme" data-key="Éš">ğŸ”Š æ’­æ”¾</button>
      </div>
      <div class="row">
        <div class="word"><strong>better</strong> <small>/ËˆbetÌ¬Éš/</small></div>
        <div class="btns">
          <button class="primary" data-type="word" data-key="better">ğŸ”Š</button>
          <button class="success rec" data-key="better">ğŸ™ å½•éŸ³</button>
        </div>
      </div>
      <div class="row">
        <div class="word"><strong>butter</strong> <small>/ËˆbÊŒtÌ¬Éš/</small></div>
        <div class="btns">
          <button class="primary" data-type="word" data-key="butter">ğŸ”Š</button>
          <button class="success rec" data-key="butter">ğŸ™ å½•éŸ³</button>
        </div>
      </div>
      <div class="row">
        <div class="word"><strong>teacher</strong> <small>/ËˆtiËtÊƒÉš/</small></div>
        <div class="btns">
          <button class="primary" data-type="word" data-key="teacher">ğŸ”Š</button>
          <button class="success rec" data-key="teacher">ğŸ™ å½•éŸ³</button>
        </div>
      </div>
    </section>

    <!-- /ÉË/ -->
    <section class="card">
      <div class="row">
        <div>
          <div class="ipa">/ÉË/</div>
          <div class="desc">é‡è¯»å·èˆŒï¼›æ›´é¥±æ»¡ã€æ›´é•¿ã€‚å¦‚ <i>her</i>, <i>bird</i>ã€‚</div>
          <div class="hint">ä¿æŒå·èˆŒ+æ›´é•¿æ—¶å€¼ã€‚</div>
        </div>
        <button class="primary" data-type="phoneme" data-key="ÉË">ğŸ”Š æ’­æ”¾</button>
      </div>
      <div class="row">
        <div class="word"><strong>her</strong> <small>/hÉË/</small></div>
        <div class="btns">
          <button class="primary" data-type="word" data-key="her">ğŸ”Š</button>
          <button class="success rec" data-key="her">ğŸ™ å½•éŸ³</button>
        </div>
      </div>
      <div class="row">
        <div class="word"><strong>term</strong> <small>/tÉËm/</small></div>
        <div class="btns">
          <button class="primary" data-type="word" data-key="term">ğŸ”Š</button>
          <button class="success rec" data-key="term">ğŸ™ å½•éŸ³</button>
        </div>
      </div>
      <div class="row">
        <div class="word"><strong>bird</strong> <small>/bÉËd/</small></div>
        <div class="btns">
          <button class="primary" data-type="word" data-key="bird">ğŸ”Š</button>
          <button class="success rec" data-key="bird">ğŸ™ å½•éŸ³</button>
        </div>
      </div>
    </section>
  </div>

  <!-- å¬è¾¨æµ‹è¯• -->
  <section class="card" style="margin-top:18px">
    <h3 style="margin:0 0 8px">å¬è¾¨æµ‹è¯•</h3>
    <p class="muted">ç‚¹å‡»â€œæ’­æ”¾æµ‹è¯•éŸ³â€ï¼Œé€‰æ‹©å®ƒå±äºå“ªä¸ªéŸ³æ ‡ï¼›ç³»ç»Ÿç»Ÿè®¡æ­£ç¡®ç‡ã€‚</p>
    <div class="toolbar">
      <button id="playTest" class="secondary">â–¶ æ’­æ”¾æµ‹è¯•éŸ³</button>
      <button class="choice" data-phoneme="/É™/">/É™/</button>
      <button class="choice" data-phoneme="/Éš/">/Éš/</button>
      <button class="choice" data-phoneme="/ÉË/">/ÉË/</button>
      <span class="pill">æ­£ç¡®ç‡ï¼š<span id="acc" class="score">0%</span>ï¼ˆ<span id="hit">0</span>/<span id="tot">0</span>ï¼‰</span>
    </div>
    <div id="feedback" class="muted"></div>
  </section>

  <!-- å½•éŸ³çŠ¶æ€ -->
  <section class="card" style="margin-top:18px">
    <h3 style="margin:0 0 8px">å½•éŸ³åŒº</h3>
    <p class="muted">ç‚¹å‡»ä»»ä¸€å•è¯æ—çš„ <b>ğŸ™ å½•éŸ³</b>ï¼›å½• 2 ç§’åè‡ªåŠ¨å›æ”¾ã€‚è‹¥è¦ A/B å¯¹æ¯”ï¼šå…ˆç‚¹å•è¯ <b>ğŸ”Š</b> å†å½•ã€‚</p>
    <audio id="playback" controls class="hidden"></audio>
    <div id="recStatus" class="muted"></div>
    <div class="hint">æç¤ºï¼šç§»åŠ¨ç«¯éœ€åœ¨ <b>HTTPS</b> é¡µé¢ï¼ˆGitHub Pages å³å¯ï¼‰æˆæƒéº¦å…‹é£ï¼›è‹¥è¯¯ç‚¹â€œç¦æ­¢â€ï¼Œåœ¨æµè§ˆå™¨åœ°å€æ çš„éº¦å…‹é£å›¾æ ‡é‡Œé‡æ–°å…è®¸ã€‚</div>
  </section>

  <audio id="localAudio" class="hidden"></audio>
</div>

<script>
/* ========= è¯­éŸ³åˆæˆï¼ˆTTSï¼‰ ========= */
const synth = window.speechSynthesis;
let voices = [];
const voiceSel = document.getElementById('voice');
const rateEl = document.getElementById('rate'), pitchEl = document.getElementById('pitch');
const rateV = document.getElementById('rateV'), pitchV = document.getElementById('pitchV');

function loadVoices(){
  voices = synth.getVoices().filter(v => /en/i.test(v.lang));
  voiceSel.innerHTML = '';
  voices.forEach((v,i)=>{
    const opt = document.createElement('option');
    opt.value = i; opt.textContent = `${v.name} â€” ${v.lang}`;
    if(/en-US/i.test(v.lang) && /Microsoft|Google|Samantha|Natural|Neural/i.test(v.name)) opt.selected = true;
    voiceSel.appendChild(opt);
  });
}
loadVoices();
if (typeof speechSynthesis !== 'undefined') {
  speechSynthesis.onvoiceschanged = loadVoices;
}
rateEl.addEventListener('input', ()=> rateV.textContent = Number(rateEl.value).toFixed(2));
pitchEl.addEventListener('input', ()=> pitchV.textContent = Number(pitchEl.value).toFixed(2));

function speak(text){
  const u = new SpeechSynthesisUtterance(text);
  const v = voices[voiceSel.value|0] || voices[0];
  if (v){ u.voice = v; u.lang = v.lang; } else { u.lang = 'en-US'; }
  u.rate = parseFloat(rateEl.value);
  u.pitch = parseFloat(pitchEl.value);
  u.volume = 1;
  speechSynthesis.cancel();
  speechSynthesis.speak(u);
}

/* ========= æ•°æ® ========= */
const PHONEME_TTS = { 'É™':'uh', 'Éš':'er', 'ÉË':'err' }; // ä¾¿äº TTS è¯»å‡ºé è¿‘çš„éŸ³è‰²
const WORDS = [
  {key:'about', ipa:'É™ËˆbaÊŠt', phoneme:'/É™/'},
  {key:'banana', ipa:'bÉ™ËˆnÃ¦nÉ™', phoneme:'/É™/'},
  {key:'sofa', ipa:'ËˆsoÊŠfÉ™', phoneme:'/É™/'},
  {key:'better', ipa:'ËˆbetÌ¬Éš', phoneme:'/Éš/'},
  {key:'butter', ipa:'ËˆbÊŒtÌ¬Éš', phoneme:'/Éš/'},
  {key:'teacher', ipa:'ËˆtiËtÊƒÉš', phoneme:'/Éš/'},
  {key:'her', ipa:'hÉË', phoneme:'/ÉË/'},
  {key:'term', ipa:'tÉËm', phoneme:'/ÉË/'},
  {key:'bird', ipa:'bÉËd', phoneme:'/ÉË/'}
];

const localAudio = document.getElementById('localAudio');
function playLocal(src){
  return new Promise((resolve,reject)=>{
    localAudio.onended = resolve;
    localAudio.onerror = reject;
    localAudio.src = src; localAudio.play().catch(reject);
  });
}
function sourceMode(){ return document.querySelector('input[name="src"]:checked').value; }

function playPhoneme(ipa){
  if (sourceMode()==='local'){
    const map = {'É™':'audio/É™.mp3','Éš':'audio/Éš.mp3','ÉË':'audio/ÉË.mp3'};
    const src = map[ipa];
    if (src) return playLocal(src).catch(()=>speak(PHONEME_TTS[ipa]||ipa));
  }
  speak(PHONEME_TTS[ipa] || ipa);
}
function playWord(key){
  if (sourceMode()==='local'){
    const src = `audio/${key}.mp3`;
    return playLocal(src).catch(()=>speak(key));
  }
  speak(key);
}

/* ========= ç»‘å®šæ’­æ”¾æŒ‰é’® ========= */
document.querySelectorAll('button[data-type="phoneme"]').forEach(btn=>{
  btn.addEventListener('click', ()=> playPhoneme(btn.dataset.key));
});
document.querySelectorAll('button[data-type="word"]').forEach(btn=>{
  btn.addEventListener('click', ()=> playWord(btn.dataset.key));
});

/* ========= è‡ªåŠ¨æ’­æ”¾ä¸€è½® ========= */
const autoBtn = document.getElementById('autoBtn');
let autoRunning = false;
autoBtn.addEventListener('click', async ()=>{
  if(autoRunning){ autoRunning=false; autoBtn.textContent='â–¶ è‡ªåŠ¨æ’­æ”¾æœ¬é¡µæ‰€æœ‰å•è¯'; return; }
  autoRunning = true; autoBtn.textContent='â¹ åœæ­¢';
  for(const w of WORDS){
    if(!autoRunning) break;
    await new Promise(r=>setTimeout(r,300));
    await (playWord(w.key)||Promise.resolve());
    await new Promise(r=>setTimeout(r,1600));
  }
  autoRunning=false; autoBtn.textContent='â–¶ è‡ªåŠ¨æ’­æ”¾æœ¬é¡µæ‰€æœ‰å•è¯';
});

/* ========= å½•éŸ³åŠŸèƒ½ ========= */
const recStatus = document.getElementById('recStatus');
const playback = document.getElementById('playback');
let mediaStream, mediaRecorder, chunks=[];

async function ensureMic(){
  if(mediaStream) return mediaStream;
  // iOS/Android/æ¡Œé¢éƒ½é€šç”¨ï¼›Safari éœ€è¦ HTTPSï¼ˆGitHub Pages æ»¡è¶³ï¼‰
  mediaStream = await navigator.mediaDevices.getUserMedia({ audio: { echoCancellation:true, noiseSuppression:true } });
  return mediaStream;
}
async function record2s(){
  try{
    await ensureMic();
    chunks=[];
    // Safari æ”¯æŒ webm/opusï¼›è€è®¾å¤‡å¯èƒ½åªæ”¯æŒ default
    const mime = MediaRecorder.isTypeSupported('audio/webm;codecs=opus') ? 'audio/webm;codecs=opus'
                : MediaRecorder.isTypeSupported('audio/mp4') ? 'audio/mp4' : '';
    mediaRecorder = new MediaRecorder(mediaStream, mime?{mimeType:mime}:{});
    return new Promise(resolve=>{
      mediaRecorder.ondataavailable = e=>{ if(e.data.size) chunks.push(e.data); };
      mediaRecorder.onstop = ()=>{
        const blob = new Blob(chunks, { type: mime || 'audio/webm' });
        const url = URL.createObjectURL(blob);
        playback.src = url; playback.classList.remove('hidden'); playback.play();
        recStatus.textContent = 'å½•éŸ³å®Œæˆï¼Œå·²è‡ªåŠ¨å›æ”¾';
        resolve();
      };
      mediaRecorder.start();
      recStatus.textContent = 'å½•éŸ³ä¸­â€¦ (2 ç§’)';
      setTimeout(()=> mediaRecorder.state==='recording' && mediaRecorder.stop(), 2000);
    });
  }catch(err){
    console.error(err);
    recStatus.textContent = 'âŒ æ— æ³•å½•éŸ³ï¼šè¯·åœ¨æµè§ˆå™¨åœ°å€æ å¼€å¯éº¦å…‹é£æƒé™ï¼›ç§»åŠ¨ç«¯è¯·ä½¿ç”¨ HTTPS é¡µé¢ï¼ˆå¦‚ GitHub Pagesï¼‰ã€‚';
  }
}
document.querySelectorAll('.rec').forEach(btn=>{
  btn.addEventListener('click', record2s);
});

/* ========= å¬è¾¨æµ‹è¯• ========= */
let current=null, hits=0, total=0;
const hitEl = document.getElementById('hit'), totEl = document.getElementById('tot'), accEl = document.getElementById('acc');
const feedback = document.getElementById('feedback');

function updateScore(){
  hitEl.textContent = hits; totEl.textContent = total;
  accEl.textContent = total ? Math.round(hits*100/total)+'%' : '0%';
}
function pick(){ return WORDS[Math.floor(Math.random()*WORDS.length)]; }
function playTest(){ current = pick(); playWord(current.key); feedback.textContent='å·²æ’­æ”¾æµ‹è¯•éŸ³ï¼Œé€‰æ‹©å®ƒå±äºå“ªä¸ªéŸ³æ ‡ã€‚'; }
document.getElementById('playTest').addEventListener('click', playTest);
document.querySelectorAll('.choice').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    if(!current){ feedback.textContent='è¯·å…ˆæ’­æ”¾æµ‹è¯•éŸ³'; return; }
    total++;
    const guess = btn.dataset.phoneme;
    if(guess===current.phoneme){ hits++; feedback.textContent='âœ… æ­£ç¡®ï¼š'+current.key+' â†’ '+current.phoneme; }
    else{ feedback.textContent='âŒ é”™è¯¯ï¼š'+current.key+' â†’ '+current.phoneme; }
    updateScore(); current=null;
  });
});
</script>
</body>
</html>
