<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>IPA Trainer — /ə/ /ɚ/ /ɝː/ · 免下载 TTS + 波形对比 + 本地录音</title>
<style>
:root{
  --bg:#0b1022;--bg2:#0f172a;--panel:#111827;--border:#1f2937;
  --txt:#e5e7eb;--muted:#9ca3af;--blue:#60a5fa;--green:#22c55e;--red:#ef4444;--cyan:#22d3ee;
}
*{box-sizing:border-box}
body{margin:0;background:linear-gradient(180deg,var(--bg),var(--bg2) 30%,var(--bg));color:var(--txt);
  font-family:system-ui,-apple-system,Segoe UI,Inter,Roboto,Helvetica,Arial,sans-serif}
.wrap{max-width:1100px;margin:20px auto;padding:16px}
h1{margin:0 0 6px;font-weight:800}
.sub{color:var(--muted);margin:0 0 12px}
.toolbar{display:flex;flex-wrap:wrap;gap:8px;margin:8px 0 16px}
.pill{display:inline-flex;align-items:center;gap:8px;background:#0b1228;border:1px solid var(--border);
  padding:8px 10px;border-radius:12px}
button{border:0;border-radius:10px;padding:8px 12px;font-weight:700;cursor:pointer;color:#041422;background:#2d3648}
button.primary{background:var(--blue)}
button.secondary{background:var(--cyan)}
button.success{background:var(--green);color:#052e16}
button.warn{background:var(--red);color:#3a0a0a}
.card{background:rgba(17,24,39,.75);backdrop-filter:blur(6px);border:1px solid var(--border);
  border-radius:16px;padding:14px;margin-bottom:14px}
.row{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:8px 0;border-top:1px dashed var(--border)}
.row:first-child{border-top:0}
.ipa{font-size:28px;font-weight:800}
.desc{color:var(--muted);font-size:13px}
.word{display:flex;flex-direction:column}
.word small{color:var(--muted)}
.btns{display:flex;gap:8px;flex-wrap:wrap}
.section-title{display:flex;align-items:baseline;gap:10px}
.badge{border:1px solid var(--border);padding:2px 8px;border-radius:999px;font-size:12px;color:var(--muted)}
.canvas-wrap{position:relative;background:#0b1228;border:1px solid var(--border);border-radius:10px;padding:8px;margin-top:8px}
canvas{width:100%;height:110px;display:block}
.pointer{background:#ffffff90;height:100%;width:2px;position:absolute;top:8px;left:-9999px}
.status{color:var(--muted);font-size:13px;margin-left:8px}
.legend{display:flex;gap:12px;flex-wrap:wrap;font-size:12px;color:var(--muted);margin:8px 0}
.dot{width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:4px}
.blue{background:var(--blue)} .green{background:var(--green)}
/* 右下角录音面板 */
.rec-panel{position:fixed;right:14px;bottom:14px;width:min(92vw,380px);max-height:60vh;overflow:auto;
  background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:10px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
.rec-panel h3{margin:4px 0 8px}
.rec-controls{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
.rec-item{display:grid;grid-template-columns:1fr auto auto;gap:6px;align-items:center;
  border-top:1px dashed var(--border);padding:6px 0}
.rec-item:first-child{border-top:0}
.rec-item small{color:var(--muted)}
.kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-size:12px;border:1px solid var(--border);border-radius:6px;padding:2px 6px;color:var(--muted)}
@media (max-width:840px){.rec-item{grid-template-columns:1fr auto}}
</style>
</head>
<body>
<div class="wrap">
  <h1>IPA Trainer — /ə/ /ɚ/ /ɝː/（免下载 TTS · 波形对比 · 本地录音）</h1>
  <p class="sub">点击任意<strong>音标/单词</strong>即可用 Google TTS（经 CORS 代理）播放并绘制蓝色“原音波形”；按“录音并保存”生成绿色“我的波形”。录音保存在浏览器（IndexedDB），可随时回放/删除/顺序播放。</p>

  <div class="toolbar">
    <span class="pill">TTS 语速 <input id="rate" type="range" min="0.6" max="1.1" step="0.05" value="0.8">
      <span id="rateV">0.80</span></span>
    <span class="pill"><span class="dot blue"></span>原音波形  <span class="dot green"></span>我的波形</span>
  </div>

  <!-- 波形与对比 -->
  <section class="card">
    <div class="section-title"><div class="ipa" id="currentLabel">—</div><span class="badge" id="currentType">未选择</span></div>
    <div class="btns" style="margin:8px 0 6px">
      <button id="compareBtn" class="secondary" disabled>🔁 对比播放（原音→录音）</button>
      <button id="resetBtn" class="warn" disabled>🧹 清除波形</button>
      <span id="status" class="status"></span>
    </div>
    <div class="canvas-wrap">
      <canvas id="refCanvas" width="1000" height="110"></canvas>
      <div id="refPointer" class="pointer"></div>
    </div>
    <div class="canvas-wrap">
      <canvas id="micCanvas" width="1000" height="110"></canvas>
      <div id="micPointer" class="pointer"></div>
    </div>
    <audio id="refAudio" controls style="margin-top:6px;width:100%"></audio>
    <audio id="micAudio" controls style="margin-top:6px;width:100%"></audio>
  </section>

  <!-- /ə/ -->
  <section class="card" id="sec-schwa">
    <div class="section-title"><div class="ipa">/ə/</div><span class="badge">Schwa：中央放松</span></div>
    <div class="row">
      <div class="word"><strong>音标原音</strong> <small>/ə/ — phoneme</small></div>
      <div class="btns">
        <button class="primary" data-phoneme="ə">🔊 播放</button>
        <button class="success" data-rec="phoneme:/ə/">🎙 录音并保存</button>
      </div>
    </div>
    <div class="row"><div class="word"><strong>a</strong> <small>about, banana, sofa</small></div>
      <div class="btns">
        <button class="primary" data-word="about">about</button>
        <button class="primary" data-word="banana">banana</button>
        <button class="primary" data-word="sofa">sofa</button>
      </div>
    </div>
    <div class="row"><div class="word"><strong>e</strong> <small>open, problem, synthesis</small></div>
      <div class="btns">
        <button class="primary" data-word="open">open</button>
        <button class="primary" data-word="problem">problem</button>
        <button class="primary" data-word="synthesis">synthesis</button>
      </div>
    </div>
    <div class="row"><div class="word"><strong>i</strong> <small>animal, president, pupil</small></div>
      <div class="btns">
        <button class="primary" data-word="animal">animal</button>
        <button class="primary" data-word="president">president</button>
        <button class="primary" data-word="pupil">pupil</button>
      </div>
    </div>
    <div class="row"><div class="word"><strong>o</strong> <small>bacon, lesson, pilot</small></div>
      <div class="btns">
        <button class="primary" data-word="bacon">bacon</button>
        <button class="primary" data-word="lesson">lesson</button>
        <button class="primary" data-word="pilot">pilot</button>
      </div>
    </div>
    <div class="row"><div class="word"><strong>u</strong> <small>circus, medium, support</small></div>
      <div class="btns">
        <button class="primary" data-word="circus">circus</button>
        <button class="primary" data-word="medium">medium</button>
        <button class="primary" data-word="support">support</button>
      </div>
    </div>
    <div class="row"><div class="word"><strong>ou</strong> <small>courageous, famous, humorous</small></div>
      <div class="btns">
        <button class="primary" data-word="courageous">courageous</button>
        <button class="primary" data-word="famous">famous</button>
        <button class="primary" data-word="humorous">humorous</button>
      </div>
    </div>
  </section>

  <!-- /ɚ/ -->
  <section class="card" id="sec-rhot-weak">
    <div class="section-title"><div class="ipa">/ɚ/</div><span class="badge">弱读卷舌</span></div>
    <div class="row">
      <div class="word"><strong>音标原音</strong> <small>/ɚ/ — phoneme</small></div>
      <div class="btns">
        <button class="primary" data-phoneme="ɚ">🔊 播放</button>
        <button class="success" data-rec="phoneme:/ɚ/">🎙 录音并保存</button>
      </div>
    </div>
    <div class="row"><div class="word"><strong>er</strong> <small>better, butter, teacher</small></div>
      <div class="btns">
        <button class="primary" data-word="better">better</button>
        <button class="primary" data-word="butter">butter</button>
        <button class="primary" data-word="teacher">teacher</button>
      </div>
    </div>
    <div class="row"><div class="word"><strong>or</strong> <small>actor, doctor, editor</small></div>
      <div class="btns">
        <button class="primary" data-word="actor">actor</button>
        <button class="primary" data-word="doctor">doctor</button>
        <button class="primary" data-word="editor">editor</button>
      </div>
    </div>
    <div class="row"><div class="word"><strong>ar</strong> <small>beggar, burglar, collar</small></div>
      <div class="btns">
        <button class="primary" data-word="beggar">beggar</button>
        <button class="primary" data-word="burglar">burglar</button>
        <button class="primary" data-word="collar">collar</button>
      </div>
    </div>
    <div class="row"><div class="word"><strong>ure</strong> <small>culture, figure, pressure</small></div>
      <div class="btns">
        <button class="primary" data-word="culture">culture</button>
        <button class="primary" data-word="figure">figure</button>
        <button class="primary" data-word="pressure">pressure</button>
      </div>
    </div>
  </section>

  <!-- /ɝː/ -->
  <section class="card" id="sec-rhot-strong">
    <div class="section-title"><div class="ipa">/ɝː/</div><span class="badge">重读卷舌</span></div>
    <div class="row">
      <div class="word"><strong>音标原音</strong> <small>/ɝː/ — phoneme</small></div>
      <div class="btns">
        <button class="primary" data-phoneme="ɝː">🔊 播放</button>
        <button class="success" data-rec="phoneme:/ɝː/">🎙 录音并保存</button>
      </div>
    </div>
    <div class="row"><div class="word"><strong>er</strong> <small>her, term, clerk</small></div>
      <div class="btns">
        <button class="primary" data-word="her">her</button>
        <button class="primary" data-word="term">term</button>
        <button class="primary" data-word="clerk">clerk</button>
      </div>
    </div>
    <div class="row"><div class="word"><strong>ear</strong> <small>earn, earth, heard</small></div>
      <div class="btns">
        <button class="primary" data-word="earn">earn</button>
        <button class="primary" data-word="earth">earth</button>
        <button class="primary" data-word="heard">heard</button>
      </div>
    </div>
    <div class="row"><div class="word"><strong>ir</strong> <small>bird, first, stir</small></div>
      <div class="btns">
        <button class="primary" data-word="bird">bird</button>
        <button class="primary" data-word="first">first</button>
        <button class="primary" data-word="stir">stir</button>
      </div>
    </div>
    <div class="row"><div class="word"><strong>ur</strong> <small>burn, nurse, turn</small></div>
      <div class="btns">
        <button class="primary" data-word="burn">burn</button>
        <button class="primary" data-word="nurse">nurse</button>
        <button class="primary" data-word="turn">turn</button>
      </div>
    </div>
    <div class="row"><div class="word"><strong>or</strong> <small>word, world, worse</small></div>
      <div class="btns">
        <button class="primary" data-word="word">word</button>
        <button class="primary" data-word="world">world</button>
        <button class="primary" data-word="worse">worse</button>
      </div>
    </div>
  </section>
</div>

<!-- 右下角：我的录音 -->
<div class="rec-panel" id="recPanel">
  <h3>我的录音 <span id="recCount" class="badge">0</span></h3>
  <div class="rec-controls">
    <button id="playAll" class="secondary" disabled>▶ 顺序播放</button>
    <button id="clearAll" class="warn" disabled>🗑 全部删除</button>
  </div>
  <div id="recList"></div>
  <div class="desc" style="margin-top:8px">
    <span class="kbd">提示</span> 录音不会自动播放；已保存到浏览器（IndexedDB）。需要麦克风权限；建议在 HTTPS（GitHub Pages）访问。
  </div>
</div>

<script>
/* =========================
   基础配置（Google TTS + 代理）
   ========================= */
const PROXY = 'https://corsproxy.io/?';
function gTTS(text, rate=0.8){
  const base = 'https://translate.google.com/translate_tts';
  const u = new URL(base);
  u.searchParams.set('ie','UTF-8');
  u.searchParams.set('q', text);
  u.searchParams.set('tl','en-US');
  u.searchParams.set('client','tw-ob');
  // 语速：0.24~4（非公开参数，可能不稳定）
  u.searchParams.set('ttsspeed', String(rate));
  return PROXY + u.toString();
}

/* 将音标转成可读的英文近似（便于 TTS） */
const PHONEME_TEXT = {
  "ə":"uh", "ɚ":"er", "ɝː":"err"
};

/* =========================
   UI 元素
   ========================= */
const rateEl = document.getElementById('rate');
const rateV  = document.getElementById('rateV');
rateEl.oninput = ()=> rateV.textContent = Number(rateEl.value).toFixed(2);

const refCanvas = document.getElementById('refCanvas');
const micCanvas = document.getElementById('micCanvas');
const refCtx = refCanvas.getContext('2d');
const micCtx = micCanvas.getContext('2d');
const refPointer = document.getElementById('refPointer');
const micPointer = document.getElementById('micPointer');
const refAudio = document.getElementById('refAudio');
const micAudio = document.getElementById('micAudio');
const compareBtn = document.getElementById('compareBtn');
const resetBtn = document.getElementById('resetBtn');
const currentLabelEl = document.getElementById('currentLabel');
const currentTypeEl = document.getElementById('currentType');
function status(msg){ document.getElementById('status').textContent = msg||''; }

/* =========================
   音频上下文 & 波形绘制
   ========================= */
let ac;
let refBuffer=null, micBuffer=null;
function acEnsure(){ if(!ac) ac = new (window.AudioContext||window.webkitAudioContext)(); return ac; }

function drawWave(canvas, ctx, data, color){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.lineWidth = 1; ctx.strokeStyle = color; ctx.beginPath();
  const mid = canvas.height/2;
  const step = Math.max(1, Math.ceil(data.length / canvas.width));
  for (let x=0; x<canvas.width; x++){
    const start = x*step;
    let min=1,max=-1;
    for(let i=0;i<step && start+i<data.length;i++){
      const v = data[start+i];
      if(v<min) min=v; if(v>max) max=v;
    }
    ctx.moveTo(x, mid + min*mid);
    ctx.lineTo(x, mid + max*mid);
  }
  ctx.stroke();
}
async function loadAndDrawRefByURL(url,labelText,labelType){
  const ctx = acEnsure();
  const res = await fetch(url);
  if(!res.ok) throw new Error('fetch failed');
  const arr = await res.arrayBuffer();
  refBuffer = await ctx.decodeAudioData(arr.slice(0));
  drawWave(refCanvas, refCtx, refBuffer.getChannelData(0), '#60a5fa');
  refAudio.src = URL.createObjectURL(new Blob([arr]));
  currentLabelEl.textContent = labelText;
  currentTypeEl.textContent  = labelType;
  compareBtn.disabled = !(refBuffer && micBuffer);
  resetBtn.disabled = !(refBuffer || micBuffer);
}

/* =========================
   点击播放（单词或音标）
   ========================= */
document.body.addEventListener('click', async (e)=>{
  const word = e.target.getAttribute('data-word');
  const ph = e.target.getAttribute('data-phoneme');
  const rec = e.target.getAttribute('data-rec');
  const rate = parseFloat(rateEl.value);

  if (word){
    try{
      const url = gTTS(word, rate);
      await loadAndDrawRefByURL(url, word, '单词');
      await refAudio.play();
      status('✅ 已加载原音波形');
    }catch(err){
      console.warn(err); status('❌ 原音获取失败（网络需可访问 Google 或代理不可用）');
    }
  }
  if (ph){
    try{
      const t = PHONEME_TEXT[ph] || 'er';
      const url = gTTS(t, rate);
      await loadAndDrawRefByURL(url, `/${ph}/`, '音标');
      await refAudio.play();
      status('✅ 已加载原音波形');
    }catch(err){
      console.warn(err); status('❌ 原音获取失败（网络需可访问 Google 或代理不可用）');
    }
  }
  if (rec){ startRecord(rec); }
});

/* =========================
   录音（实时波形）+ 保存到 IndexedDB
   ========================= */
let mediaStream, mediaRecorder, chunks=[];
let analyser, dataArray, rafIdLive=null;

async function ensureMic(){
  if (mediaStream) return mediaStream;
  mediaStream = await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:true,noiseSuppression:true}});
  // 实时波形
  const ctx = acEnsure();
  const src = ctx.createMediaStreamSource(mediaStream);
  analyser = ctx.createAnalyser(); analyser.fftSize = 2048;
  src.connect(analyser);
  dataArray = new Uint8Array(analyser.fftSize);
  return mediaStream;
}
function drawLive(){
  if (!analyser) return;
  analyser.getByteTimeDomainData(dataArray);
  micCtx.fillStyle = '#0b1228'; micCtx.fillRect(0,0,micCanvas.width,micCanvas.height);
  micCtx.lineWidth=1; micCtx.strokeStyle = '#22c55e'; micCtx.beginPath();
  const sliceWidth = micCanvas.width / dataArray.length;
  let x = 0;
  for (let i=0;i<dataArray.length;i++){
    const v = dataArray[i]/128.0, y = v * micCanvas.height/2;
    if (i===0) micCtx.moveTo(x,y);
    else micCtx.lineTo(x,y);
    x += sliceWidth;
  }
  micCtx.stroke();
  rafIdLive = requestAnimationFrame(drawLive);
}

async function startRecord(tag){
  try{
    await ensureMic(); chunks=[];
    const mime = MediaRecorder.isTypeSupported('audio/webm;codecs=opus')?'audio/webm;codecs=opus':
                 MediaRecorder.isTypeSupported('audio/mp4')?'audio/mp4':'';
    mediaRecorder = new MediaRecorder(mediaStream, mime?{mimeType:mime}:{});
    status('🎙 正在录音…再次点击“录音并保存”将重新开始；默认 2 秒后自动停止');
    if (rafIdLive) cancelAnimationFrame(rafIdLive);
    drawLive();

    let stopped=false;
    mediaRecorder.ondataavailable = e=>{ if(e.data.size) chunks.push(e.data); };
    mediaRecorder.onstop = async ()=>{
      if(stopped) return; stopped=true;
      if (rafIdLive) cancelAnimationFrame(rafIdLive);
      const blob = new Blob(chunks, {type: mime || 'audio/webm'});
      await saveRecording(tag, blob);
      // 同时加载到绿波形（便于立刻对比）
      const arr = await blob.arrayBuffer();
      const ctx = acEnsure();
      micBuffer = await ctx.decodeAudioData(arr.slice(0));
      drawWave(micCanvas, micCtx, micBuffer.getChannelData(0), '#22c55e');
      micAudio.src = URL.createObjectURL(blob);
      compareBtn.disabled = !(refBuffer && micBuffer);
      resetBtn.disabled = !(refBuffer || micBuffer);
      updateRecList();
      status('✅ 录音已保存到“我的录音”面板（不自动播放）');
    };
    mediaRecorder.start();
    setTimeout(()=>{ try{mediaRecorder.stop();}catch{} }, 2000);
  }catch(e){
    console.error(e); status('❌ 无法录音：请允许麦克风；建议通过 HTTPS 访问');
  }
}

/* =========================
   IndexedDB（录音持久化）
   ========================= */
const DB_NAME='ipa-trainer', DB_STORE='recs';
function idbOpen(){
  return new Promise((resolve,reject)=>{
    const req = indexedDB.open(DB_NAME,1);
    req.onupgradeneeded = ()=>{ req.result.createObjectStore(DB_STORE,{keyPath:'id'}); };
    req.onsuccess=()=>resolve(req.result);
    req.onerror=()=>reject(req.error);
  });
}
async function idbTxn(mode){ const db = await idbOpen(); return db.transaction(DB_STORE,mode); }
async function saveRecording(tag, blob){
  const tx = await idbTxn('readwrite');
  const store = tx.objectStore(DB_STORE);
  const id = Date.now().toString(36)+'_'+Math.random().toString(36).slice(2,8);
  const rec = { id, tag, ts: Date.now(), mime: blob.type||'audio/webm', blob };
  store.put(rec);
  return new Promise((res,rej)=>{ tx.oncomplete=()=>res(rec); tx.onerror=()=>rej(tx.error); });
}
async function getAllRecs(){
  const tx = await idbTxn('readonly'); const store = tx.objectStore(DB_STORE);
  return new Promise((res,rej)=>{
    const out=[]; const req = store.openCursor();
    req.onsuccess=()=>{ const cur=req.result; if(cur){ out.push(cur.value); cur.continue(); } else res(out); };
    req.onerror=()=>rej(req.error);
  });
}
async function deleteRec(id){
  const tx = await idbTxn('readwrite'); const store = tx.objectStore(DB_STORE);
  store.delete(id);
  return new Promise((res,rej)=>{ tx.oncomplete=()=>res(); tx.onerror=()=>rej(tx.error); });
}
async function clearAllRecs(){
  const tx = await idbTxn('readwrite'); const store = tx.objectStore(DB_STORE);
  store.clear();
  return new Promise((res,rej)=>{ tx.oncomplete=()=>res(); tx.onerror=()=>rej(tx.error); });
}

/* =========================
   右下角“我的录音”面板
   ========================= */
const recListEl = document.getElementById('recList');
const recCountEl = document.getElementById('recCount');
const playAllBtn = document.getElementById('playAll');
const clearAllBtn = document.getElementById('clearAll');

async function updateRecList(){
  const recs = await getAllRecs();
  recs.sort((a,b)=>a.ts-b.ts);
  recCountEl.textContent = recs.length;
  playAllBtn.disabled = clearAllBtn.disabled = recs.length===0;
  recListEl.innerHTML='';
  for (const r of recs){
    const row = document.createElement('div'); row.className='rec-item';
    const time = new Date(r.ts).toLocaleTimeString();
    row.innerHTML = `
      <div><strong>${r.tag}</strong><br><small>${time}</small></div>
      <button class="secondary" data-play-id="${r.id}">▶ 播放</button>
      <button class="warn" data-del-id="${r.id}">🗑 删除</button>
    `;
    recListEl.appendChild(row);
  }
}
recListEl.addEventListener('click', async (e)=>{
  const pid = e.target.getAttribute('data-play-id');
  const did = e.target.getAttribute('data-del-id');
  if (pid){
    const recs = await getAllRecs();
    const r = recs.find(x=>x.id===pid);
    if (r){
      micAudio.src = URL.createObjectURL(r.blob);
      const arr = await r.blob.arrayBuffer();
      const ctx = acEnsure();
      micBuffer = await ctx.decodeAudioData(arr.slice(0));
      drawWave(micCanvas, micCtx, micBuffer.getChannelData(0), '#22c55e');
      compareBtn.disabled = !(refBuffer && micBuffer);
      resetBtn.disabled = !(refBuffer || micBuffer);
      await micAudio.play();
    }
  }
  if (did){
    await deleteRec(did);
    updateRecList();
  }
});
playAllBtn.addEventListener('click', async ()=>{
  const recs = await getAllRecs();
  recs.sort((a,b)=>a.ts-b.ts);
  for (const r of recs){
    micAudio.src = URL.createObjectURL(r.blob);
    const arr = await r.blob.arrayBuffer();
    const ctx = acEnsure();
    micBuffer = await ctx.decodeAudioData(arr.slice(0));
    drawWave(micCanvas, micCtx, micBuffer.getChannelData(0), '#22c55e');
    compareBtn.disabled = !(refBuffer && micBuffer);
    resetBtn.disabled = !(refBuffer || micBuffer);
    await micAudio.play(); await new Promise(res=>micAudio.onended=res);
    await new Promise(res=>setTimeout(res,250));
  }
});
clearAllBtn.addEventListener('click', async ()=>{
  if (!confirm('确定删除所有录音吗？')) return;
  await clearAllRecs(); updateRecList();
});

/* =========================
   对比播放：原音→录音 + 指针
   ========================= */
let rafIdPtr=null;
function stopPointers(){ cancelAnimationFrame(rafIdPtr); refPointer.style.left='-9999px'; micPointer.style.left='-9999px'; }
function animatePointers(){
  const refDur = refAudio.duration || (refBuffer? refBuffer.duration:0);
  const micDur = micAudio.duration || (micBuffer? micBuffer.duration:0);
  function frame(){
    if(!refAudio.paused && refDur>0){
      const x = (refAudio.currentTime/refDur) * (refCanvas.clientWidth-2);
      refPointer.style.left = (8 + Math.max(0,Math.min(x, refCanvas.clientWidth-2))) + 'px';
    } else if (refAudio.paused && refAudio.currentTime===0){ refPointer.style.left='-9999px'; }
    if(!micAudio.paused && micDur>0){
      const x2 = (micAudio.currentTime/micDur) * (micCanvas.clientWidth-2);
      micPointer.style.left = (8 + Math.max(0,Math.min(x2, micCanvas.clientWidth-2))) + 'px';
    } else if (micAudio.paused && micAudio.currentTime===0){ micPointer.style.left='-9999px'; }
    rafIdPtr = requestAnimationFrame(frame);
  }
  rafIdPtr = requestAnimationFrame(frame);
}
document.getElementById('compareBtn').addEventListener('click', async ()=>{
  if(!(refBuffer && micBuffer)){ status('先播放一个“原音”获取蓝波形，再在右下角播放一条录音获取绿波形'); return; }
  stopPointers();
  try{
    status('对比播放：原音…'); refAudio.currentTime=0; await refAudio.play(); animatePointers();
    await new Promise(r=>refAudio.onended=r);
    stopPointers(); await new Promise(r=>setTimeout(r,600));
    status('对比播放：录音…'); micAudio.currentTime=0; await micAudio.play(); animatePointers();
    await new Promise(r=>micAudio.onended=r);
    stopPointers(); status('✅ 对比完成（可重复点击）');
  }catch(e){ console.warn(e); stopPointers(); status('⚠️ 自动播放被阻止或无音频源'); }
});
resetBtn.addEventListener('click', ()=>{
  stopPointers(); refCtx.clearRect(0,0,refCanvas.width,refCanvas.height);
  micCtx.clearRect(0,0,micCanvas.width,micCanvas.height);
  refBuffer=null; micBuffer=null; refAudio.removeAttribute('src'); micAudio.removeAttribute('src');
  compareBtn.disabled=true; resetBtn.disabled=true; status('已清除波形');
});

/* =========================
   初始化
   ========================= */
updateRecList();
status('提示：点击音标或单词播放（蓝波形）→ “录音并保存”（生成绿波形）→ 点“对比播放”。');
</script>
</body>
</html>
