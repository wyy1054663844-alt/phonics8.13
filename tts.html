<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>IPA Trainer â€” /É™/ /Éš/ /ÉË/ Â· å…ä¸‹è½½ TTS + æ³¢å½¢å¯¹æ¯” + æœ¬åœ°å½•éŸ³</title>
<style>
:root{
  --bg:#0b1022;--bg2:#0f172a;--panel:#111827;--border:#1f2937;
  --txt:#e5e7eb;--muted:#9ca3af;--blue:#60a5fa;--green:#22c55e;--red:#ef4444;--cyan:#22d3ee;
}
*{box-sizing:border-box}
body{margin:0;background:linear-gradient(180deg,var(--bg),var(--bg2) 30%,var(--bg));color:var(--txt);
  font-family:system-ui,-apple-system,Segoe UI,Inter,Roboto,Helvetica,Arial,sans-serif}
.wrap{max-width:1100px;margin:20px auto;padding:16px}
h1{margin:0 0 6px;font-weight:800}
.sub{color:var(--muted);margin:0 0 12px}
.toolbar{display:flex;flex-wrap:wrap;gap:8px;margin:8px 0 16px}
.pill{display:inline-flex;align-items:center;gap:8px;background:#0b1228;border:1px solid var(--border);
  padding:8px 10px;border-radius:12px}
button{border:0;border-radius:10px;padding:8px 12px;font-weight:700;cursor:pointer;color:#041422;background:#2d3648}
button.primary{background:var(--blue)}
button.secondary{background:var(--cyan)}
button.success{background:var(--green);color:#052e16}
button.warn{background:var(--red);color:#3a0a0a}
.card{background:rgba(17,24,39,.75);backdrop-filter:blur(6px);border:1px solid var(--border);
  border-radius:16px;padding:14px;margin-bottom:14px}
.row{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:8px 0;border-top:1px dashed var(--border)}
.row:first-child{border-top:0}
.ipa{font-size:28px;font-weight:800}
.desc{color:var(--muted);font-size:13px}
.word{display:flex;flex-direction:column}
.word small{color:var(--muted)}
.btns{display:flex;gap:8px;flex-wrap:wrap}
.section-title{display:flex;align-items:baseline;gap:10px}
.badge{border:1px solid var(--border);padding:2px 8px;border-radius:999px;font-size:12px;color:var(--muted)}
.canvas-wrap{position:relative;background:#0b1228;border:1px solid var(--border);border-radius:10px;padding:8px;margin-top:8px}
canvas{width:100%;height:110px;display:block}
.pointer{background:#ffffff90;height:100%;width:2px;position:absolute;top:8px;left:-9999px}
.status{color:var(--muted);font-size:13px;margin-left:8px}
.legend{display:flex;gap:12px;flex-wrap:wrap;font-size:12px;color:var(--muted);margin:8px 0}
.dot{width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:4px}
.blue{background:var(--blue)} .green{background:var(--green)}
/* å³ä¸‹è§’å½•éŸ³é¢æ¿ */
.rec-panel{position:fixed;right:14px;bottom:14px;width:min(92vw,380px);max-height:60vh;overflow:auto;
  background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:10px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
.rec-panel h3{margin:4px 0 8px}
.rec-controls{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
.rec-item{display:grid;grid-template-columns:1fr auto auto;gap:6px;align-items:center;
  border-top:1px dashed var(--border);padding:6px 0}
.rec-item:first-child{border-top:0}
.rec-item small{color:var(--muted)}
.kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-size:12px;border:1px solid var(--border);border-radius:6px;padding:2px 6px;color:var(--muted)}
@media (max-width:840px){.rec-item{grid-template-columns:1fr auto}}
</style>
</head>
<body>
<div class="wrap">
  <h1>IPA Trainer â€” /É™/ /Éš/ /ÉË/ï¼ˆå…ä¸‹è½½ TTS Â· æ³¢å½¢å¯¹æ¯” Â· æœ¬åœ°å½•éŸ³ï¼‰</h1>
  <p class="sub">ç‚¹å‡»ä»»æ„<strong>éŸ³æ ‡/å•è¯</strong>å³å¯ç”¨ Google TTSï¼ˆç» CORS ä»£ç†ï¼‰æ’­æ”¾å¹¶ç»˜åˆ¶è“è‰²â€œåŸéŸ³æ³¢å½¢â€ï¼›æŒ‰â€œå½•éŸ³å¹¶ä¿å­˜â€ç”Ÿæˆç»¿è‰²â€œæˆ‘çš„æ³¢å½¢â€ã€‚å½•éŸ³ä¿å­˜åœ¨æµè§ˆå™¨ï¼ˆIndexedDBï¼‰ï¼Œå¯éšæ—¶å›æ”¾/åˆ é™¤/é¡ºåºæ’­æ”¾ã€‚</p>

  <div class="toolbar">
    <span class="pill">TTS è¯­é€Ÿ <input id="rate" type="range" min="0.6" max="1.1" step="0.05" value="0.8">
      <span id="rateV">0.80</span></span>
    <span class="pill"><span class="dot blue"></span>åŸéŸ³æ³¢å½¢  <span class="dot green"></span>æˆ‘çš„æ³¢å½¢</span>
  </div>

  <!-- æ³¢å½¢ä¸å¯¹æ¯” -->
  <section class="card">
    <div class="section-title"><div class="ipa" id="currentLabel">â€”</div><span class="badge" id="currentType">æœªé€‰æ‹©</span></div>
    <div class="btns" style="margin:8px 0 6px">
      <button id="compareBtn" class="secondary" disabled>ğŸ” å¯¹æ¯”æ’­æ”¾ï¼ˆåŸéŸ³â†’å½•éŸ³ï¼‰</button>
      <button id="resetBtn" class="warn" disabled>ğŸ§¹ æ¸…é™¤æ³¢å½¢</button>
      <span id="status" class="status"></span>
    </div>
    <div class="canvas-wrap">
      <canvas id="refCanvas" width="1000" height="110"></canvas>
      <div id="refPointer" class="pointer"></div>
    </div>
    <div class="canvas-wrap">
      <canvas id="micCanvas" width="1000" height="110"></canvas>
      <div id="micPointer" class="pointer"></div>
    </div>
    <audio id="refAudio" controls style="margin-top:6px;width:100%"></audio>
    <audio id="micAudio" controls style="margin-top:6px;width:100%"></audio>
  </section>

  <!-- /É™/ -->
  <section class="card" id="sec-schwa">
    <div class="section-title"><div class="ipa">/É™/</div><span class="badge">Schwaï¼šä¸­å¤®æ”¾æ¾</span></div>
    <div class="row">
      <div class="word"><strong>éŸ³æ ‡åŸéŸ³</strong> <small>/É™/ â€” phoneme</small></div>
      <div class="btns">
        <button class="primary" data-phoneme="É™">ğŸ”Š æ’­æ”¾</button>
        <button class="success" data-rec="phoneme:/É™/">ğŸ™ å½•éŸ³å¹¶ä¿å­˜</button>
      </div>
    </div>
    <div class="row"><div class="word"><strong>a</strong> <small>about, banana, sofa</small></div>
      <div class="btns">
        <button class="primary" data-word="about">about</button>
        <button class="primary" data-word="banana">banana</button>
        <button class="primary" data-word="sofa">sofa</button>
      </div>
    </div>
    <div class="row"><div class="word"><strong>e</strong> <small>open, problem, synthesis</small></div>
      <div class="btns">
        <button class="primary" data-word="open">open</button>
        <button class="primary" data-word="problem">problem</button>
        <button class="primary" data-word="synthesis">synthesis</button>
      </div>
    </div>
    <div class="row"><div class="word"><strong>i</strong> <small>animal, president, pupil</small></div>
      <div class="btns">
        <button class="primary" data-word="animal">animal</button>
        <button class="primary" data-word="president">president</button>
        <button class="primary" data-word="pupil">pupil</button>
      </div>
    </div>
    <div class="row"><div class="word"><strong>o</strong> <small>bacon, lesson, pilot</small></div>
      <div class="btns">
        <button class="primary" data-word="bacon">bacon</button>
        <button class="primary" data-word="lesson">lesson</button>
        <button class="primary" data-word="pilot">pilot</button>
      </div>
    </div>
    <div class="row"><div class="word"><strong>u</strong> <small>circus, medium, support</small></div>
      <div class="btns">
        <button class="primary" data-word="circus">circus</button>
        <button class="primary" data-word="medium">medium</button>
        <button class="primary" data-word="support">support</button>
      </div>
    </div>
    <div class="row"><div class="word"><strong>ou</strong> <small>courageous, famous, humorous</small></div>
      <div class="btns">
        <button class="primary" data-word="courageous">courageous</button>
        <button class="primary" data-word="famous">famous</button>
        <button class="primary" data-word="humorous">humorous</button>
      </div>
    </div>
  </section>

  <!-- /Éš/ -->
  <section class="card" id="sec-rhot-weak">
    <div class="section-title"><div class="ipa">/Éš/</div><span class="badge">å¼±è¯»å·èˆŒ</span></div>
    <div class="row">
      <div class="word"><strong>éŸ³æ ‡åŸéŸ³</strong> <small>/Éš/ â€” phoneme</small></div>
      <div class="btns">
        <button class="primary" data-phoneme="Éš">ğŸ”Š æ’­æ”¾</button>
        <button class="success" data-rec="phoneme:/Éš/">ğŸ™ å½•éŸ³å¹¶ä¿å­˜</button>
      </div>
    </div>
    <div class="row"><div class="word"><strong>er</strong> <small>better, butter, teacher</small></div>
      <div class="btns">
        <button class="primary" data-word="better">better</button>
        <button class="primary" data-word="butter">butter</button>
        <button class="primary" data-word="teacher">teacher</button>
      </div>
    </div>
    <div class="row"><div class="word"><strong>or</strong> <small>actor, doctor, editor</small></div>
      <div class="btns">
        <button class="primary" data-word="actor">actor</button>
        <button class="primary" data-word="doctor">doctor</button>
        <button class="primary" data-word="editor">editor</button>
      </div>
    </div>
    <div class="row"><div class="word"><strong>ar</strong> <small>beggar, burglar, collar</small></div>
      <div class="btns">
        <button class="primary" data-word="beggar">beggar</button>
        <button class="primary" data-word="burglar">burglar</button>
        <button class="primary" data-word="collar">collar</button>
      </div>
    </div>
    <div class="row"><div class="word"><strong>ure</strong> <small>culture, figure, pressure</small></div>
      <div class="btns">
        <button class="primary" data-word="culture">culture</button>
        <button class="primary" data-word="figure">figure</button>
        <button class="primary" data-word="pressure">pressure</button>
      </div>
    </div>
  </section>

  <!-- /ÉË/ -->
  <section class="card" id="sec-rhot-strong">
    <div class="section-title"><div class="ipa">/ÉË/</div><span class="badge">é‡è¯»å·èˆŒ</span></div>
    <div class="row">
      <div class="word"><strong>éŸ³æ ‡åŸéŸ³</strong> <small>/ÉË/ â€” phoneme</small></div>
      <div class="btns">
        <button class="primary" data-phoneme="ÉË">ğŸ”Š æ’­æ”¾</button>
        <button class="success" data-rec="phoneme:/ÉË/">ğŸ™ å½•éŸ³å¹¶ä¿å­˜</button>
      </div>
    </div>
    <div class="row"><div class="word"><strong>er</strong> <small>her, term, clerk</small></div>
      <div class="btns">
        <button class="primary" data-word="her">her</button>
        <button class="primary" data-word="term">term</button>
        <button class="primary" data-word="clerk">clerk</button>
      </div>
    </div>
    <div class="row"><div class="word"><strong>ear</strong> <small>earn, earth, heard</small></div>
      <div class="btns">
        <button class="primary" data-word="earn">earn</button>
        <button class="primary" data-word="earth">earth</button>
        <button class="primary" data-word="heard">heard</button>
      </div>
    </div>
    <div class="row"><div class="word"><strong>ir</strong> <small>bird, first, stir</small></div>
      <div class="btns">
        <button class="primary" data-word="bird">bird</button>
        <button class="primary" data-word="first">first</button>
        <button class="primary" data-word="stir">stir</button>
      </div>
    </div>
    <div class="row"><div class="word"><strong>ur</strong> <small>burn, nurse, turn</small></div>
      <div class="btns">
        <button class="primary" data-word="burn">burn</button>
        <button class="primary" data-word="nurse">nurse</button>
        <button class="primary" data-word="turn">turn</button>
      </div>
    </div>
    <div class="row"><div class="word"><strong>or</strong> <small>word, world, worse</small></div>
      <div class="btns">
        <button class="primary" data-word="word">word</button>
        <button class="primary" data-word="world">world</button>
        <button class="primary" data-word="worse">worse</button>
      </div>
    </div>
  </section>
</div>

<!-- å³ä¸‹è§’ï¼šæˆ‘çš„å½•éŸ³ -->
<div class="rec-panel" id="recPanel">
  <h3>æˆ‘çš„å½•éŸ³ <span id="recCount" class="badge">0</span></h3>
  <div class="rec-controls">
    <button id="playAll" class="secondary" disabled>â–¶ é¡ºåºæ’­æ”¾</button>
    <button id="clearAll" class="warn" disabled>ğŸ—‘ å…¨éƒ¨åˆ é™¤</button>
  </div>
  <div id="recList"></div>
  <div class="desc" style="margin-top:8px">
    <span class="kbd">æç¤º</span> å½•éŸ³ä¸ä¼šè‡ªåŠ¨æ’­æ”¾ï¼›å·²ä¿å­˜åˆ°æµè§ˆå™¨ï¼ˆIndexedDBï¼‰ã€‚éœ€è¦éº¦å…‹é£æƒé™ï¼›å»ºè®®åœ¨ HTTPSï¼ˆGitHub Pagesï¼‰è®¿é—®ã€‚
  </div>
</div>

<script>
/* =========================
   åŸºç¡€é…ç½®ï¼ˆGoogle TTS + ä»£ç†ï¼‰
   ========================= */
const PROXY = 'https://corsproxy.io/?';
function gTTS(text, rate=0.8){
  const base = 'https://translate.google.com/translate_tts';
  const u = new URL(base);
  u.searchParams.set('ie','UTF-8');
  u.searchParams.set('q', text);
  u.searchParams.set('tl','en-US');
  u.searchParams.set('client','tw-ob');
  // è¯­é€Ÿï¼š0.24~4ï¼ˆéå…¬å¼€å‚æ•°ï¼Œå¯èƒ½ä¸ç¨³å®šï¼‰
  u.searchParams.set('ttsspeed', String(rate));
  return PROXY + u.toString();
}

/* å°†éŸ³æ ‡è½¬æˆå¯è¯»çš„è‹±æ–‡è¿‘ä¼¼ï¼ˆä¾¿äº TTSï¼‰ */
const PHONEME_TEXT = {
  "É™":"uh", "Éš":"er", "ÉË":"err"
};

/* =========================
   UI å…ƒç´ 
   ========================= */
const rateEl = document.getElementById('rate');
const rateV  = document.getElementById('rateV');
rateEl.oninput = ()=> rateV.textContent = Number(rateEl.value).toFixed(2);

const refCanvas = document.getElementById('refCanvas');
const micCanvas = document.getElementById('micCanvas');
const refCtx = refCanvas.getContext('2d');
const micCtx = micCanvas.getContext('2d');
const refPointer = document.getElementById('refPointer');
const micPointer = document.getElementById('micPointer');
const refAudio = document.getElementById('refAudio');
const micAudio = document.getElementById('micAudio');
const compareBtn = document.getElementById('compareBtn');
const resetBtn = document.getElementById('resetBtn');
const currentLabelEl = document.getElementById('currentLabel');
const currentTypeEl = document.getElementById('currentType');
function status(msg){ document.getElementById('status').textContent = msg||''; }

/* =========================
   éŸ³é¢‘ä¸Šä¸‹æ–‡ & æ³¢å½¢ç»˜åˆ¶
   ========================= */
let ac;
let refBuffer=null, micBuffer=null;
function acEnsure(){ if(!ac) ac = new (window.AudioContext||window.webkitAudioContext)(); return ac; }

function drawWave(canvas, ctx, data, color){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.lineWidth = 1; ctx.strokeStyle = color; ctx.beginPath();
  const mid = canvas.height/2;
  const step = Math.max(1, Math.ceil(data.length / canvas.width));
  for (let x=0; x<canvas.width; x++){
    const start = x*step;
    let min=1,max=-1;
    for(let i=0;i<step && start+i<data.length;i++){
      const v = data[start+i];
      if(v<min) min=v; if(v>max) max=v;
    }
    ctx.moveTo(x, mid + min*mid);
    ctx.lineTo(x, mid + max*mid);
  }
  ctx.stroke();
}
async function loadAndDrawRefByURL(url,labelText,labelType){
  const ctx = acEnsure();
  const res = await fetch(url);
  if(!res.ok) throw new Error('fetch failed');
  const arr = await res.arrayBuffer();
  refBuffer = await ctx.decodeAudioData(arr.slice(0));
  drawWave(refCanvas, refCtx, refBuffer.getChannelData(0), '#60a5fa');
  refAudio.src = URL.createObjectURL(new Blob([arr]));
  currentLabelEl.textContent = labelText;
  currentTypeEl.textContent  = labelType;
  compareBtn.disabled = !(refBuffer && micBuffer);
  resetBtn.disabled = !(refBuffer || micBuffer);
}

/* =========================
   ç‚¹å‡»æ’­æ”¾ï¼ˆå•è¯æˆ–éŸ³æ ‡ï¼‰
   ========================= */
document.body.addEventListener('click', async (e)=>{
  const word = e.target.getAttribute('data-word');
  const ph = e.target.getAttribute('data-phoneme');
  const rec = e.target.getAttribute('data-rec');
  const rate = parseFloat(rateEl.value);

  if (word){
    try{
      const url = gTTS(word, rate);
      await loadAndDrawRefByURL(url, word, 'å•è¯');
      await refAudio.play();
      status('âœ… å·²åŠ è½½åŸéŸ³æ³¢å½¢');
    }catch(err){
      console.warn(err); status('âŒ åŸéŸ³è·å–å¤±è´¥ï¼ˆç½‘ç»œéœ€å¯è®¿é—® Google æˆ–ä»£ç†ä¸å¯ç”¨ï¼‰');
    }
  }
  if (ph){
    try{
      const t = PHONEME_TEXT[ph] || 'er';
      const url = gTTS(t, rate);
      await loadAndDrawRefByURL(url, `/${ph}/`, 'éŸ³æ ‡');
      await refAudio.play();
      status('âœ… å·²åŠ è½½åŸéŸ³æ³¢å½¢');
    }catch(err){
      console.warn(err); status('âŒ åŸéŸ³è·å–å¤±è´¥ï¼ˆç½‘ç»œéœ€å¯è®¿é—® Google æˆ–ä»£ç†ä¸å¯ç”¨ï¼‰');
    }
  }
  if (rec){ startRecord(rec); }
});

/* =========================
   å½•éŸ³ï¼ˆå®æ—¶æ³¢å½¢ï¼‰+ ä¿å­˜åˆ° IndexedDB
   ========================= */
let mediaStream, mediaRecorder, chunks=[];
let analyser, dataArray, rafIdLive=null;

async function ensureMic(){
  if (mediaStream) return mediaStream;
  mediaStream = await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:true,noiseSuppression:true}});
  // å®æ—¶æ³¢å½¢
  const ctx = acEnsure();
  const src = ctx.createMediaStreamSource(mediaStream);
  analyser = ctx.createAnalyser(); analyser.fftSize = 2048;
  src.connect(analyser);
  dataArray = new Uint8Array(analyser.fftSize);
  return mediaStream;
}
function drawLive(){
  if (!analyser) return;
  analyser.getByteTimeDomainData(dataArray);
  micCtx.fillStyle = '#0b1228'; micCtx.fillRect(0,0,micCanvas.width,micCanvas.height);
  micCtx.lineWidth=1; micCtx.strokeStyle = '#22c55e'; micCtx.beginPath();
  const sliceWidth = micCanvas.width / dataArray.length;
  let x = 0;
  for (let i=0;i<dataArray.length;i++){
    const v = dataArray[i]/128.0, y = v * micCanvas.height/2;
    if (i===0) micCtx.moveTo(x,y);
    else micCtx.lineTo(x,y);
    x += sliceWidth;
  }
  micCtx.stroke();
  rafIdLive = requestAnimationFrame(drawLive);
}

async function startRecord(tag){
  try{
    await ensureMic(); chunks=[];
    const mime = MediaRecorder.isTypeSupported('audio/webm;codecs=opus')?'audio/webm;codecs=opus':
                 MediaRecorder.isTypeSupported('audio/mp4')?'audio/mp4':'';
    mediaRecorder = new MediaRecorder(mediaStream, mime?{mimeType:mime}:{});
    status('ğŸ™ æ­£åœ¨å½•éŸ³â€¦å†æ¬¡ç‚¹å‡»â€œå½•éŸ³å¹¶ä¿å­˜â€å°†é‡æ–°å¼€å§‹ï¼›é»˜è®¤ 2 ç§’åè‡ªåŠ¨åœæ­¢');
    if (rafIdLive) cancelAnimationFrame(rafIdLive);
    drawLive();

    let stopped=false;
    mediaRecorder.ondataavailable = e=>{ if(e.data.size) chunks.push(e.data); };
    mediaRecorder.onstop = async ()=>{
      if(stopped) return; stopped=true;
      if (rafIdLive) cancelAnimationFrame(rafIdLive);
      const blob = new Blob(chunks, {type: mime || 'audio/webm'});
      await saveRecording(tag, blob);
      // åŒæ—¶åŠ è½½åˆ°ç»¿æ³¢å½¢ï¼ˆä¾¿äºç«‹åˆ»å¯¹æ¯”ï¼‰
      const arr = await blob.arrayBuffer();
      const ctx = acEnsure();
      micBuffer = await ctx.decodeAudioData(arr.slice(0));
      drawWave(micCanvas, micCtx, micBuffer.getChannelData(0), '#22c55e');
      micAudio.src = URL.createObjectURL(blob);
      compareBtn.disabled = !(refBuffer && micBuffer);
      resetBtn.disabled = !(refBuffer || micBuffer);
      updateRecList();
      status('âœ… å½•éŸ³å·²ä¿å­˜åˆ°â€œæˆ‘çš„å½•éŸ³â€é¢æ¿ï¼ˆä¸è‡ªåŠ¨æ’­æ”¾ï¼‰');
    };
    mediaRecorder.start();
    setTimeout(()=>{ try{mediaRecorder.stop();}catch{} }, 2000);
  }catch(e){
    console.error(e); status('âŒ æ— æ³•å½•éŸ³ï¼šè¯·å…è®¸éº¦å…‹é£ï¼›å»ºè®®é€šè¿‡ HTTPS è®¿é—®');
  }
}

/* =========================
   IndexedDBï¼ˆå½•éŸ³æŒä¹…åŒ–ï¼‰
   ========================= */
const DB_NAME='ipa-trainer', DB_STORE='recs';
function idbOpen(){
  return new Promise((resolve,reject)=>{
    const req = indexedDB.open(DB_NAME,1);
    req.onupgradeneeded = ()=>{ req.result.createObjectStore(DB_STORE,{keyPath:'id'}); };
    req.onsuccess=()=>resolve(req.result);
    req.onerror=()=>reject(req.error);
  });
}
async function idbTxn(mode){ const db = await idbOpen(); return db.transaction(DB_STORE,mode); }
async function saveRecording(tag, blob){
  const tx = await idbTxn('readwrite');
  const store = tx.objectStore(DB_STORE);
  const id = Date.now().toString(36)+'_'+Math.random().toString(36).slice(2,8);
  const rec = { id, tag, ts: Date.now(), mime: blob.type||'audio/webm', blob };
  store.put(rec);
  return new Promise((res,rej)=>{ tx.oncomplete=()=>res(rec); tx.onerror=()=>rej(tx.error); });
}
async function getAllRecs(){
  const tx = await idbTxn('readonly'); const store = tx.objectStore(DB_STORE);
  return new Promise((res,rej)=>{
    const out=[]; const req = store.openCursor();
    req.onsuccess=()=>{ const cur=req.result; if(cur){ out.push(cur.value); cur.continue(); } else res(out); };
    req.onerror=()=>rej(req.error);
  });
}
async function deleteRec(id){
  const tx = await idbTxn('readwrite'); const store = tx.objectStore(DB_STORE);
  store.delete(id);
  return new Promise((res,rej)=>{ tx.oncomplete=()=>res(); tx.onerror=()=>rej(tx.error); });
}
async function clearAllRecs(){
  const tx = await idbTxn('readwrite'); const store = tx.objectStore(DB_STORE);
  store.clear();
  return new Promise((res,rej)=>{ tx.oncomplete=()=>res(); tx.onerror=()=>rej(tx.error); });
}

/* =========================
   å³ä¸‹è§’â€œæˆ‘çš„å½•éŸ³â€é¢æ¿
   ========================= */
const recListEl = document.getElementById('recList');
const recCountEl = document.getElementById('recCount');
const playAllBtn = document.getElementById('playAll');
const clearAllBtn = document.getElementById('clearAll');

async function updateRecList(){
  const recs = await getAllRecs();
  recs.sort((a,b)=>a.ts-b.ts);
  recCountEl.textContent = recs.length;
  playAllBtn.disabled = clearAllBtn.disabled = recs.length===0;
  recListEl.innerHTML='';
  for (const r of recs){
    const row = document.createElement('div'); row.className='rec-item';
    const time = new Date(r.ts).toLocaleTimeString();
    row.innerHTML = `
      <div><strong>${r.tag}</strong><br><small>${time}</small></div>
      <button class="secondary" data-play-id="${r.id}">â–¶ æ’­æ”¾</button>
      <button class="warn" data-del-id="${r.id}">ğŸ—‘ åˆ é™¤</button>
    `;
    recListEl.appendChild(row);
  }
}
recListEl.addEventListener('click', async (e)=>{
  const pid = e.target.getAttribute('data-play-id');
  const did = e.target.getAttribute('data-del-id');
  if (pid){
    const recs = await getAllRecs();
    const r = recs.find(x=>x.id===pid);
    if (r){
      micAudio.src = URL.createObjectURL(r.blob);
      const arr = await r.blob.arrayBuffer();
      const ctx = acEnsure();
      micBuffer = await ctx.decodeAudioData(arr.slice(0));
      drawWave(micCanvas, micCtx, micBuffer.getChannelData(0), '#22c55e');
      compareBtn.disabled = !(refBuffer && micBuffer);
      resetBtn.disabled = !(refBuffer || micBuffer);
      await micAudio.play();
    }
  }
  if (did){
    await deleteRec(did);
    updateRecList();
  }
});
playAllBtn.addEventListener('click', async ()=>{
  const recs = await getAllRecs();
  recs.sort((a,b)=>a.ts-b.ts);
  for (const r of recs){
    micAudio.src = URL.createObjectURL(r.blob);
    const arr = await r.blob.arrayBuffer();
    const ctx = acEnsure();
    micBuffer = await ctx.decodeAudioData(arr.slice(0));
    drawWave(micCanvas, micCtx, micBuffer.getChannelData(0), '#22c55e');
    compareBtn.disabled = !(refBuffer && micBuffer);
    resetBtn.disabled = !(refBuffer || micBuffer);
    await micAudio.play(); await new Promise(res=>micAudio.onended=res);
    await new Promise(res=>setTimeout(res,250));
  }
});
clearAllBtn.addEventListener('click', async ()=>{
  if (!confirm('ç¡®å®šåˆ é™¤æ‰€æœ‰å½•éŸ³å—ï¼Ÿ')) return;
  await clearAllRecs(); updateRecList();
});

/* =========================
   å¯¹æ¯”æ’­æ”¾ï¼šåŸéŸ³â†’å½•éŸ³ + æŒ‡é’ˆ
   ========================= */
let rafIdPtr=null;
function stopPointers(){ cancelAnimationFrame(rafIdPtr); refPointer.style.left='-9999px'; micPointer.style.left='-9999px'; }
function animatePointers(){
  const refDur = refAudio.duration || (refBuffer? refBuffer.duration:0);
  const micDur = micAudio.duration || (micBuffer? micBuffer.duration:0);
  function frame(){
    if(!refAudio.paused && refDur>0){
      const x = (refAudio.currentTime/refDur) * (refCanvas.clientWidth-2);
      refPointer.style.left = (8 + Math.max(0,Math.min(x, refCanvas.clientWidth-2))) + 'px';
    } else if (refAudio.paused && refAudio.currentTime===0){ refPointer.style.left='-9999px'; }
    if(!micAudio.paused && micDur>0){
      const x2 = (micAudio.currentTime/micDur) * (micCanvas.clientWidth-2);
      micPointer.style.left = (8 + Math.max(0,Math.min(x2, micCanvas.clientWidth-2))) + 'px';
    } else if (micAudio.paused && micAudio.currentTime===0){ micPointer.style.left='-9999px'; }
    rafIdPtr = requestAnimationFrame(frame);
  }
  rafIdPtr = requestAnimationFrame(frame);
}
document.getElementById('compareBtn').addEventListener('click', async ()=>{
  if(!(refBuffer && micBuffer)){ status('å…ˆæ’­æ”¾ä¸€ä¸ªâ€œåŸéŸ³â€è·å–è“æ³¢å½¢ï¼Œå†åœ¨å³ä¸‹è§’æ’­æ”¾ä¸€æ¡å½•éŸ³è·å–ç»¿æ³¢å½¢'); return; }
  stopPointers();
  try{
    status('å¯¹æ¯”æ’­æ”¾ï¼šåŸéŸ³â€¦'); refAudio.currentTime=0; await refAudio.play(); animatePointers();
    await new Promise(r=>refAudio.onended=r);
    stopPointers(); await new Promise(r=>setTimeout(r,600));
    status('å¯¹æ¯”æ’­æ”¾ï¼šå½•éŸ³â€¦'); micAudio.currentTime=0; await micAudio.play(); animatePointers();
    await new Promise(r=>micAudio.onended=r);
    stopPointers(); status('âœ… å¯¹æ¯”å®Œæˆï¼ˆå¯é‡å¤ç‚¹å‡»ï¼‰');
  }catch(e){ console.warn(e); stopPointers(); status('âš ï¸ è‡ªåŠ¨æ’­æ”¾è¢«é˜»æ­¢æˆ–æ— éŸ³é¢‘æº'); }
});
resetBtn.addEventListener('click', ()=>{
  stopPointers(); refCtx.clearRect(0,0,refCanvas.width,refCanvas.height);
  micCtx.clearRect(0,0,micCanvas.width,micCanvas.height);
  refBuffer=null; micBuffer=null; refAudio.removeAttribute('src'); micAudio.removeAttribute('src');
  compareBtn.disabled=true; resetBtn.disabled=true; status('å·²æ¸…é™¤æ³¢å½¢');
});

/* =========================
   åˆå§‹åŒ–
   ========================= */
updateRecList();
status('æç¤ºï¼šç‚¹å‡»éŸ³æ ‡æˆ–å•è¯æ’­æ”¾ï¼ˆè“æ³¢å½¢ï¼‰â†’ â€œå½•éŸ³å¹¶ä¿å­˜â€ï¼ˆç”Ÿæˆç»¿æ³¢å½¢ï¼‰â†’ ç‚¹â€œå¯¹æ¯”æ’­æ”¾â€ã€‚');
</script>
</body>
</html>
